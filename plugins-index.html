

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Plugins &mdash; fuglu 1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="fuglu 1 documentation" href="index.html" />
    <link rel="next" title="Support" href="help-index.html" />
    <link rel="prev" title="Operation" href="operation-index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="help-index.html" title="Support"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="operation-index.html" title="Operation"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">fuglu 1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="plugins">
<h1>Plugins<a class="headerlink" href="#plugins" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
<ul class="simple">
</ul>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The fuglu core does nothing except receiving mails from postfix and sending them back. All functionality
is written in plugins which can be enabled or disabled at will. Fuglu provides plugins for the most common
mail filtering requirements, but if some functionality is missing, it is easy to add new plugins without knowing
all of fuglu&#8217;s internals.</p>
</div>
<div class="section" id="types-of-plugins">
<h2>Types of plugins<a class="headerlink" href="#types-of-plugins" title="Permalink to this headline">¶</a></h2>
<div class="section" id="scanner-plugins">
<h3>Scanner Plugins<a class="headerlink" href="#scanner-plugins" title="Permalink to this headline">¶</a></h3>
<p>Scanner plugins are the most important type of plugins. They do the actual mail content filtering.
Plugins are run in the order specified in the <tt class="docutils literal"><span class="pre">plugins=</span></tt> configuration option. Each plugin returns an action
for the message:</p>
<blockquote>
<div><ul class="simple">
<li><strong>DUNNO</strong>  : This plugin decides not to take any final action, continue with the next plugin (this is the most common case)</li>
<li><strong>ACCEPT</strong> : Whitelist this message, don&#8217;t run any remaining plugins</li>
<li><strong>DELETE</strong> : Silently delete this message (The sender will think it has been delivered)</li>
<li><strong>DEFER</strong>  : Temporary Reject (4xx error), used for error conditions in after-queue mode or things like greylisting in before-queue mode</li>
<li><strong>REJECT</strong> : Reject this message, should only be used in before-queue mode (in after-queue mode this would produce a bounce / backscatter)</li>
</ul>
</div></blockquote>
<p>If one of the plugins returns something other than <em>DUNNO</em>, all remaining scanner plugins are skipped.
If all plugins return DUNNO, the message is accepted and re-injected to postfix.</p>
</div>
<div class="section" id="prepender-plugins">
<h3>Prepender Plugins<a class="headerlink" href="#prepender-plugins" title="Permalink to this headline">¶</a></h3>
<p>Prepender plugins run before the scanner plugins and have the ability to alter the
list of scanner plugins to be run. This can be used for example to have different plugins
run for incoming or outgoing mails or to skip whitelisted messages.</p>
</div>
<div class="section" id="appender-plugins">
<h3>Appender Plugins<a class="headerlink" href="#appender-plugins" title="Permalink to this headline">¶</a></h3>
<p>Appender plugins are run after the scanner plugins when the message has alr
eady been re-injected into postfix
(or rejected or deleted or...) so they don&#8217;t increase your scanning time . They are mostly used for statistical tasks, updating counters in database etc.</p>
</div>
</div>
<div class="section" id="plugin-configuration">
<h2>Plugin configuration<a class="headerlink" href="#plugin-configuration" title="Permalink to this headline">¶</a></h2>
<p>Each plugin has its own configuration section in <tt class="docutils literal"><span class="pre">/etc/fuglu/fuglu.conf</span></tt> or any <tt class="docutils literal"><span class="pre">*.conf</span></tt> in <tt class="docutils literal"><span class="pre">/etc/fuglu/conf.d</span></tt>. The section is usually
named like the plugin itself.</p>
<p>For example, the Spamassassin Plugin&#8217;s Name is <tt class="docutils literal"><span class="pre">SAplugin</span></tt>, so it would search for a <tt class="docutils literal"><span class="pre">[SAPlugin]</span></tt> config section.</p>
<div class="section" id="suspect-filters">
<h3>Suspect Filters<a class="headerlink" href="#suspect-filters" title="Permalink to this headline">¶</a></h3>
<p>SuspectFilter are special rule files used by many fuglu plugins. Often they define actions a plugin should take based on a suspects header or tag.</p>
<p>The format is : &lt;headername&gt; &lt;regex&gt; &lt;optional argument&gt;</p>
<dl class="docutils">
<dt>&lt;headername&gt; can be any of...</dt>
<dd><ul class="first simple">
<li>a email header name, eg <tt class="docutils literal"><span class="pre">Received</span></tt>, <tt class="docutils literal"><span class="pre">To</span></tt>, <tt class="docutils literal"><span class="pre">From</span></tt>, <tt class="docutils literal"><span class="pre">Subject</span></tt> ... also supports &#8216;*&#8217; as wildcard character</li>
<li><tt class="docutils literal"><span class="pre">mime:````&lt;headeraneme&gt;</span></tt> to get mime Headers in the message payload  eg: <tt class="docutils literal"><span class="pre">mime:Content-Disposition</span></tt></li>
<li>one of fuglus builtin names to get envelope data:</li>
</ul>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">envelope_from</span></tt>  (the envelope from address)</li>
<li><tt class="docutils literal"><span class="pre">from_domain</span></tt> (domain part of envelope_from)</li>
<li><tt class="docutils literal"><span class="pre">envelope_to</span></tt> (envelope to address)</li>
<li><tt class="docutils literal"><span class="pre">to_domain</span></tt> (domain part of envelope_to)</li>
</ul>
</div></blockquote>
<ul class="last simple">
<li>a <tt class="docutils literal"><span class="pre">message</span> <span class="pre">Tag</span></tt> prepended by the &#64; symbol, eg. <tt class="docutils literal"><span class="pre">&#64;incomingport</span></tt></li>
<li><tt class="docutils literal"><span class="pre">body:raw</span></tt>&#8216; to match the the decoded message body (only applies to text/* partsl)</li>
<li><tt class="docutils literal"><span class="pre">body:stripped</span></tt> or just <tt class="docutils literal"><span class="pre">body</span></tt> to match the the  message body (only applies to text/* parts), with stripped tags and newlines replaced with space (similar to SpamAssassin body rules)</li>
<li><tt class="docutils literal"><span class="pre">body:full</span></tt> to match the full body</li>
</ul>
</dd>
</dl>
<p><tt class="docutils literal"><span class="pre">&lt;regex&gt;</span></tt> is a standard python regular expression applied to &lt;header&gt;. if the regex is not enclosed by forward slashes, be sure not to include any whitespace in the regex, it must be one continous string. To match whitespace, use <tt class="docutils literal"><span class="pre">\s</span></tt>. all regexes that are not enclosed in forward slashes are automatically <tt class="docutils literal"><span class="pre">case</span> <span class="pre">insensitive</span></tt> and support multiple lines (re.DOTALL is enabled, so the newline character is matched by a dot). with slashes, the regex flags can be defined manually, eg.</p>
<div class="highlight-python"><pre>Subject /hello world/i match hello world, case insensitive</pre>
</div>
<p><tt class="docutils literal"><span class="pre">&lt;optional</span> <span class="pre">argument&gt;</span></tt> depends on the plugin that reads this header filter file, some don&#8217;t need arguments at all. Please refer to the plugin documentation.</p>
<p>Filter files are automatically reloaded if you change anything, so you don&#8217;t need to restart fuglu.</p>
<p>Example:</p>
<div class="highlight-python"><pre>#normal header test
Subject hello   Hello in the subject!
MIME-Version ^1\.0$ Mime Version is 1.0

#builtin special fields
to_domain       (\.)?fuglu.org$ Sent to fuglu.org or any subdomain
envelope_from ^sender@example.com$

#match a tag from a previous plugin
@SAPlugin.report MISSING_HEADER

#wildcard
X-Spam-* .*     a X-Spam-&lt;something&gt; header exists

#decoded body text parts
body    Viagra

#full body
body:full ^--SPAMMY-MIME-BOUNDARY

#mime-headers
mime:Content-Type ^application\/x-msdos-program$</pre>
</div>
</div>
</div>
<div class="section" id="plugins-included-in-fuglu">
<h2>Plugins included in Fuglu<a class="headerlink" href="#plugins-included-in-fuglu" title="Permalink to this headline">¶</a></h2>
<div class="section" id="saplugin">
<h3>SAPlugin<a class="headerlink" href="#saplugin" title="Permalink to this headline">¶</a></h3>
<p>Plugin: fuglu.plugins.sa.SAPlugin</p>
<p>This plugin passes suspects to a spamassassin daemon.</p>
<p>Prerequisites: SPAMD must be installed and running (not necessarily on the same box as fuglu)</p>
<p>Notes for developers:</p>
<p>if forwardoriginal=False, the message source will be completely replaced with the answer from spamd.</p>
<p>Tags:</p>
<blockquote>
<div><ul class="simple">
<li>reads <tt class="docutils literal"><span class="pre">SAPlugin.skip</span></tt>, skips scanning if this is True</li>
<li>sets <tt class="docutils literal"><span class="pre">spam['spamassassin']</span></tt> (boolean)</li>
<li>sets <tt class="docutils literal"><span class="pre">SAPlugin.spamscore</span></tt> (float) if possible</li>
<li>sets <tt class="docutils literal"><span class="pre">SAPlugin.time</span></tt> (float)</li>
<li>sets <tt class="docutils literal"><span class="pre">SAPlugin.skipreason</span></tt> (string) if the message was not scanned (fuglu &gt;0.5.0)</li>
</ul>
</div></blockquote>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><pre>[SAPlugin]
#how often should fuglu retry the connection before giving up
retries=3
#action if there is a problem (DUNNO, DEFER)
problemaction=DEFER
#reject message template if running in pre-queue mode
rejectmessage=message identified as spam
#forward the original message or replace the content as returned by spamassassin
if this is set to True/1/Yes , no spamassassin headers will be visible in the final message.
"original" in this case means "as passed to spamassassin", eg. if 'scanoriginal' is set to 0 above this will forward the
message as retreived from previous plugins
forwardoriginal=0
#consult spamassassins(or any other) sql blacklist for messages that are too big for spam checks
requires the sql extension to be enabled
check_sql_blacklist=0
#sqlalchemy db connect string
sql_blacklist_dbconnectstring=mysql:///localhost/spamassassin
#SQL query to get the blacklist entries for a suspect
you may use template variables: ${from_address} ${from_domain} ${to_address} ${to_domain}
sql_blacklist_sql=SELECT value FROM userpref WHERE prefid='blacklist_from' AND username in ('@GLOBAL',concat('%',${to_domain}),${to_address})
#maximum size in bytes. larger messages will be skipped
maxsize=256000
#what header does sa set to indicate the spam status
spamheader=X-Spam-Status
#hostname where spamd runs
host=localhost
#what should we do with high spam (spam score above highspamlevel)
highspamaction=DEFAULTHIGHSPAMACTION
#how long should we wait for an answer from sa
timeout=30
#spamscore threshold to mark a message as high spam
highspamlevel=15
#enable SA user configuration
peruserconfig=1
#tcp port number
port=783
#should we scan the original message as retreived from postfix or scan the current state
in fuglu (which might have been altered by previous plugins)
only set this to disabled if you have a custom plugin that adds special headers to the message that will be
used in spamassassin rules
scanoriginal=1
#what should we do with low spam (eg. detected as spam, but score not over highspamlevel)
lowspamaction=DEFAULTLOWSPAMACTION</pre>
</div>
</div>
</div>
<div class="section" id="clamavplugin">
<h3>ClamavPlugin<a class="headerlink" href="#clamavplugin" title="Permalink to this headline">¶</a></h3>
<p>Plugin: fuglu.plugins.clamav.ClamavPlugin</p>
<p>This plugin passes suspects to a clam daemon.</p>
<p>Actions: This plugin will delete infected messages. If clamd is not reachable or times out, messages can be DEFERRED.</p>
<p>Prerequisites: You must have clamd installed (for performance reasons I recommend it to be on the same box, but this is not absoluely necessary)</p>
<p>Notes for developers:</p>
<p>Tags:</p>
<blockquote>
<div><ul class="simple">
<li>sets <tt class="docutils literal"><span class="pre">virus['ClamAV']</span></tt> (boolean)</li>
<li>sets <tt class="docutils literal"><span class="pre">ClamavPlugin.virus</span></tt> (list of strings) - virus names found in message</li>
<li>sets <tt class="docutils literal"><span class="pre">ClamavPlugin.time</span></tt> (float)</li>
</ul>
</div></blockquote>
<div class="section" id="id1">
<h4>Configuration<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><pre>[ClamavPlugin]
#how often should fuglu retry the connection before giving up
retries=3
#hostname where clamd runs
host=localhost
#reject message template if running in pre-queue mode and virusaction=REJECT
rejectmessage=threat detected: ${virusname}
#socket timeout
timeout=10
#action if there is a problem (DUNNO, DEFER)
problemaction=DEFER
#maximum message size, larger messages will not be scanned.
should match the 'StreamMaxLength' config option in clamd.conf
maxsize=22000000
#tcp port number or path to clamd.sock for unix domain sockets
example /var/lib/clamav/clamd.sock or on ubuntu: /var/run/clamav/clamd.ctl
port=3310
#action if infection is detected (DUNNO, REJECT, DELETE)
virusaction=DEFAULTVIRUSACTION</pre>
</div>
</div>
</div>
<div class="section" id="attachment-blocker">
<h3>Attachment Blocker<a class="headerlink" href="#attachment-blocker" title="Permalink to this headline">¶</a></h3>
<p>Plugin: fuglu.plugins.attachment.FiletypePlugin</p>
<p>This plugin checks message attachments. You can configure what filetypes or filenames are allowed to pass through fuglu. If a attachment is not allowed, the message is deleted and the sender receives a bounce error message. The plugin uses the &#8216;&#8217;&#8216;file&#8217;&#8216;&#8217; library to identify attachments, so even if a smart sender renames his executable to .txt, fuglu will detect it.</p>
<p>Attachment rules can be defined globally, per domain or per user.</p>
<p>Actions: This plugin will delete messages if they contain blocked attachments.</p>
<p>Prerequisites: You must have the python &#8216;&#8217;file&#8217;&#8217; or &#8216;&#8217;magic&#8217;&#8217; module installed</p>
<p>The attachment configuration files are in /etc/fuglu/rules. You whould have two default files there: &#8216;&#8217;&#8216;default-filenames.conf&#8217;&#8216;&#8217; which defines what filenames are allowed and &#8216;&#8217;&#8216;default-filetypes.conf&#8217;&#8216;&#8217; which defines what content types a attachment may have.</p>
<p>For domain rules, create a new file &#8216;&#8217;&#8216;&lt;domainname&gt;-filenames.conf&#8217;&#8216;&#8217; / &#8216;&#8217;&#8216;&lt;domainname&gt;-filetypes.conf&#8217;&#8216;&#8217; , eg. &#8216;&#8217;fuglu.org-filenames.conf&#8217;&#8217; / &#8216;&#8217;fuglu.org-filetypes.conf&#8217;&#8216;</p>
<p>For individual user rules, create a new file &#8216;&#8217;&#8216;&lt;useremail&gt;-filenames.conf&#8217;&#8216;&#8217; / &#8216;&#8217;&#8216;&lt;useremail&gt;-filetypes.conf&#8217;&#8216;&#8217;, eg. <a class="reference external" href="mailto:{{{oli&#37;&#52;&#48;fuglu&#46;org-filenames&#46;conf">{{{oli<span>&#64;</span>fuglu<span>&#46;</span>org-filenames<span>&#46;</span>conf</a>}}} / <a class="reference external" href="mailto:{{{oli&#37;&#52;&#48;fuglu&#46;org-filetypes&#46;conf">{{{oli<span>&#64;</span>fuglu<span>&#46;</span>org-filetypes<span>&#46;</span>conf</a>}}}</p>
<p>The format of those files is as follows: Each line should have three parts, seperated by tabs (or any whitespace):
&lt;action&gt;    &lt;regular expression&gt;   &lt;description or error message&gt;</p>
<dl class="docutils">
<dt>&lt;action&gt; can be one of:</dt>
<dd><ul class="first last simple">
<li>allow : this file is ok, don&#8217;t do further checks (you might use it for safe content types like text). Do not blindly create &#8216;allow&#8217; rules. It&#8217;s safer to make no rule at all, if no other rules hit, the file will be accepted</li>
<li>deny : delete this message and send the error message/description back to the sender</li>
<li>delete : silently delete the message, no error is sent back, and &#8216;blockaction&#8217; is ignored</li>
</ul>
</dd>
</dl>
<p>&lt;regular expression&gt; is a standard python regex. in x-filenames.conf this will be applied to the attachment name . in x-filetypes.conf this will be applied to the mime type of the file as well as the file type returned by the &#8216;&#8217;file&#8217;&#8217; command.</p>
<p>example of default-filetypes.conf:</p>
<p>{{{
allow    text        -
allow    script    -
allow    archive        -
allow    postscript    -
deny    self-extract    No self-extracting archives
deny    executable    No programs allowed
deny    ELF        No programs allowed
deny    Registry    No Windows Registry files allowed
}}}</p>
<p>small extract from default-filenames.conf:</p>
<p>{{{
deny    .ico$            Windows icon file security vulnerability
deny    .ani$            Windows animated cursor file security vulnerability
deny    .cur$            Windows cursor file security vulnerability
deny    .hlp$            Windows help file security vulnerability</p>
<p>allow    .jpg$            -
allow    .gif$            -
}}}</p>
<p>Note: The files will be reloaded automatically after a few secs (you do not need to kill -HUP / restart fuglu)</p>
<p>The bounce template (eg /etc/fuglu/templates/blockedfile.tmpl) should look like this:</p>
<p>{{{
To: ${from_address}
Subject: Blocked attachment</p>
<p>Your message to ${to_address} contains a blocked attachment and has been deleted.</p>
<p>${blockinfo}</p>
<p>You may add this file to a zip archive (or similar) and send it again.
}}}</p>
<p>eg. define headers for your message at the beginning, followed by a blank line. Then append the message body.</p>
<p>&#8216;&#8217;${blockinfo}&#8217;&#8217; will be replaced with the text you specified in the third column of the rule that blocked this message.
See CommonTemplateVars for commonly available template variables in Fuglu.</p>
<div class="section" id="id2">
<h4>Configuration<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><pre>[FiletypePlugin]
#inform the sender about blocked attachments
sendbounce=1
#Mail template for the bounce to inform sender about blocked attachment
template_blockedfile=/etc/fuglu/templates/blockedfile.tmpl
#what should the plugin do when a blocked attachment is detected
REJECT : reject the message (recommended in pre-queue mode)
DELETE : discard messages
DUNNO  : mark as blocked but continue anyway (eg. if you have a later quarantine plugin)
blockaction=DELETE
#sqlalchemy connectstring to load rules from a database and use files only as fallback. requires SQL extension to be enabled
dbconnectstring=
#sql query to load rules from a db. #:scope will be replaced by the recipient address first, then by the recipient domain
:check will be replaced by either 'filename' to get filename rules or 'contenttype' to get content type rules
query=SELECT action,regex,description FROM attachmentrules WHERE scope=:scope AND checktype=:checktype ORDER BY prio
#directory that contains attachment rules
rulesdir=/etc/fuglu/rules</pre>
</div>
</div>
</div>
<div class="section" id="archiveplugin">
<h3>ArchivePlugin<a class="headerlink" href="#archiveplugin" title="Permalink to this headline">¶</a></h3>
<p>Plugin: fuglu.plugins.archive.ArchivePlugin</p>
<p>This plugins stores a copy of the message if it matches certain criteria (Suspect Filter).
You can use this if you want message archives for your domains or to debug problems occuring only for certain recipients.</p>
<p>Examples for the archive.regex filter file:</p>
<p>archive messages to domain &#8216;&#8217;test.com&#8217;&#8216;:</p>
<p><tt class="docutils literal"><span class="pre">to_domain</span> <span class="pre">test\.com</span></tt></p>
<p>archive messages from <a class="reference external" href="mailto:oli&#37;&#52;&#48;fuglu&#46;org">oli<span>&#64;</span>fuglu<span>&#46;</span>org</a>:</p>
<p><tt class="docutils literal"><span class="pre">envelope_from</span> <span class="pre">oli&#64;fuglu\.org</span></tt></p>
<p>you can also append &#8220;yes&#8221; and &#8220;no&#8221; to the rules to create a more advanced configuration. Lets say we want to archive all messages to <a class="reference external" href="mailto:sales&#37;&#52;&#48;fuglu&#46;org">sales<span>&#64;</span>fuglu<span>&#46;</span>org</a> and all regular messages <a class="reference external" href="mailto:support&#37;&#52;&#48;fuglu&#46;org">support<span>&#64;</span>fuglu<span>&#46;</span>org</a> except the ones created by automated scripts like logwatch or daily backup messages etc.</p>
<p>envelope_to <a class="reference external" href="mailto:sales&#37;&#52;&#48;fuglu&#46;org">sales<span>&#64;</span>fuglu<span>&#46;</span>org</a> yes
envelope_from logwatch&#64;.*fuglu.org   no
from <a class="reference external" href="mailto:backups&#37;&#52;&#48;fuglu&#46;org">backups<span>&#64;</span>fuglu<span>&#46;</span>org</a> no
envelope_to <a class="reference external" href="mailto:support&#37;&#52;&#48;fuglu&#46;org">support<span>&#64;</span>fuglu<span>&#46;</span>org</a>      yes</p>
<div class="section" id="id3">
<h4>Configuration<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><pre>[ArchivePlugin]
#create a subdirectory of the destination domain within archivedir
makedomainsubdir=1
#if true/1/yes: store original message
if false/0/no: store message probably altered by previous plugins, eg with spamassassin headers
storeoriginal=1
#storage for archived messages
archivedir=/tmp
#Archiving SuspectFilter File
archiverules=/etc/fuglu/archive.regex</pre>
</div>
</div>
</div>
<div class="section" id="vacationplugin">
<h3>VacationPlugin<a class="headerlink" href="#vacationplugin" title="Permalink to this headline">¶</a></h3>
<p>Plugin: fuglu.plugins.vacation.VacationPlugin</p>
<p>Sends out-of-office reply messages. Configuration is got from a sql database. Replies are only sent once per day per sender. The plugin will not reply to any &#8216;automated&#8217; messages (Mailingslists, Spams, Bounces etc)</p>
<p>Requires: SQLAlechemy Extension</p>
<dl class="docutils">
<dt>Required DB Tables:</dt>
<dd><ul class="first last simple">
<li>vacation (fuglu reads this table only, must be filled from elsewhere)<ul>
<li>id int : id of this vacation</li>
<li>created timestamp :  creation timestamp</li>
<li>enabled boolean (eg. tinyint) : if disabled, no vacation reply will be sent</li>
<li>start timestamp: replies will only be sent after this point in time</li>
<li>end timestamp: replies will only be sent before this point in time</li>
<li>awayuser varchar: the email address of the user that is on vacation</li>
<li>subject: subject of the vacation message</li>
<li>body : body of the vacation message</li>
<li>ignoresender: whitespace delimited list of domains or email addresses that should not receive vacation replies</li>
</ul>
</li>
<li>vacationreply (this table is filled by fuglu)<ul>
<li>id int: id of the reply</li>
<li>vacation_id : id of the vacation</li>
<li>sent timestamp: timestamp when the reply was sent</li>
<li>recipient: recipient to whom the reply was sent</li>
</ul>
</li>
</ul>
</dd>
</dl>
<p>SQL Example for mysql:</p>
<div class="highlight-python"><pre>CREATE TABLE `vacation` (
  `id` int(11) NOT NULL auto_increment,
  `created` timestamp NOT NULL default now(),
  `start` timestamp NOT NULL,
  `end` timestamp NOT NULL ,
  `enabled` tinyint(1) NOT NULL default 1,
  `awayuser` varchar(255) NOT NULL,
  `subject` varchar(255) NOT NULL,
  `body` text NOT NULL,
  `ignoresender` text NOT NULL,
  PRIMARY KEY  (`id`),
  UNIQUE(`awayuser`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ;


CREATE  TABLE `vacationreply` (
  `id` int(11) NOT NULL auto_increment,
  `recipient` varchar(255) NOT NULL,
  `vacation_id` int(11) NOT NULL,
     `sent` timestamp not null default now(),
  PRIMARY KEY  (`id`),
  KEY `vacation_id` (`vacation_id`),
  CONSTRAINT `vacation_ibfk_1` FOREIGN KEY (`vacation_id`) REFERENCES `vacation` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;</pre>
</div>
<div class="section" id="id4">
<h4>Configuration<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><pre>[VacationPlugin]
#sqlalchemy connectstring to load vacations
dbconnectstring=</pre>
</div>
</div>
</div>
<div class="section" id="ssspplugin">
<h3>SSSPPlugin<a class="headerlink" href="#ssspplugin" title="Permalink to this headline">¶</a></h3>
<p>Plugin: fuglu.plugins.sssp.SSSPPlugin</p>
<blockquote>
<div>This plugin scans the suspect using the sophos SSSP protocol.</div></blockquote>
<p>Prerequisites: Requires a running sophos daemon with dynamic interface (SAVDI)</p>
<div class="section" id="id5">
<h4>Configuration<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><pre>[SSSPPlugin]
#how often should fuglu retry the connection before giving up
retries=3
#hostname where the SSSP server runs
host=localhost
#reject message template if running in pre-queue mode and virusaction=REJECT
rejectmessage=threat detected: ${virusname}
#socket timeout
timeout=10
#action if there is a problem (DUNNO, DEFER)
problemaction=DEFER
#maximum message size, larger messages will not be scanned.
maxsize=22000000
#tcp port or path to unix socket
port=4010
#action if infection is detected (DUNNO, REJECT, DELETE)
virusaction=DEFAULTVIRUSACTION</pre>
</div>
</div>
</div>
<div class="section" id="f-prot-plugin">
<h3>F-Prot Plugin<a class="headerlink" href="#f-prot-plugin" title="Permalink to this headline">¶</a></h3>
<p>Plugin: fuglu.plugins.fprot.FprotPlugin</p>
<blockquote>
<div>This plugin passes suspects to a f-prot scan daemon</div></blockquote>
<p>Prerequisites: f-protd must be installed and running, not necessarily on the same box as fuglu though.</p>
<p>Notes for developers:</p>
<p>Tags:</p>
<blockquote>
<div><ul class="simple">
<li>sets <tt class="docutils literal"><span class="pre">virus['F-Prot']</span></tt> (boolean)</li>
<li>sets <tt class="docutils literal"><span class="pre">FprotPlugin.virus</span></tt> (list of strings) - virus names found in message</li>
<li>sets <tt class="docutils literal"><span class="pre">FprotPlugin.time</span></tt> (float)</li>
</ul>
</div></blockquote>
<div class="section" id="id6">
<h4>Configuration<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><pre>[FprotPlugin]
#maximum retries on failed connections
retries=3
#hostname where fpscand runs
host=localhost
#reject message template if running in pre-queue mode and virusaction=REJECT
rejectmessage=threat detected: ${virusname}
#if fpscand runs on a different host than fuglu, set this to 1 to send the message over the network instead of just the filename
networkmode=0
#network timeout
timeout=20
#plugin action if scan fails
problemaction=DEFER
#maximum message size to scan
maxsize=10485000
#fpscand port
port=10200
#plugin action if threat is detected
virusaction=DEFAULTVIRUSACTION</pre>
</div>
</div>
</div>
<div class="section" id="icapplugin">
<h3>ICAPPlugin<a class="headerlink" href="#icapplugin" title="Permalink to this headline">¶</a></h3>
<p>Plugin: fuglu.plugins.icap.ICAPPlugin</p>
<p>ICAP Antivirus Plugin (Sophos / Symantec / ....)</p>
<p>Prerequisites: requires an ICAP capable antivirus engine somewhere in your network</p>
<div class="section" id="id7">
<h4>Configuration<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><pre>[ICAPPlugin]
#how often should fuglu retry the connection before giving up
retries=3
#hostname where the ICAP server runs
host=localhost
#reject message template if running in pre-queue mode and virusaction=REJECT
rejectmessage=threat detected: ${virusname}
#ICAP Av scan service, usually AVSCAN (sophos, symantec)
service=AVSCAN
#socket timeout
timeout=10
#action if there is a problem (DUNNO, DEFER)
problemaction=DEFER
#name of the virus engine behind the icap service. used to inform other plugins. can be anything like 'sophos', 'symantec', ...
enginename=icap-generic
#maximum message size, larger messages will not be scanned.
maxsize=22000000
#tcp port or path to unix socket
port=1344
#action if infection is detected (DUNNO, REJECT, DELETE)
virusaction=DEFAULTVIRUSACTION</pre>
</div>
</div>
</div>
<div class="section" id="headerplugin">
<h3>HeaderPlugin<a class="headerlink" href="#headerplugin" title="Permalink to this headline">¶</a></h3>
<p>Plugin: fuglu.plugins.headers.HeaderPlugin</p>
<p>Removes specified headers from message</p>
<div class="section" id="id8">
<h4>Configuration<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><pre>[HeaderPlugin]
#headers to remove from incoming messages, comma separated
removeheaders=</pre>
</div>
</div>
</div>
<div class="section" id="actionoverrideplugin">
<h3>ActionOverridePlugin<a class="headerlink" href="#actionoverrideplugin" title="Permalink to this headline">¶</a></h3>
<p>Plugin: fuglu.plugins.actionoverride.ActionOverridePlugin</p>
<blockquote>
<div>override Actions based on a Suspect Filter file. For example, delete all messages from a specific sender domain.</div></blockquote>
<div class="section" id="id9">
<h4>Configuration<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><pre>[ActionOverridePlugin]
#Rules file
actionrules=/etc/fuglu/actionrules.regex</pre>
</div>
</div>
</div>
<div class="section" id="pluginskipper">
<h3>PluginSkipper<a class="headerlink" href="#pluginskipper" title="Permalink to this headline">¶</a></h3>
<p>Plugin: fuglu.plugins.p_skipper.PluginSkipper</p>
<p>Skips plugins based on standard filter file
This can be used for example to skip spam filters on outgoing messages.
eg. put this in /etc/fuglu/skipplugins.regex:</p>
<p>&#64;incomingport    1099    SAPlugin</p>
<div class="section" id="id10">
<h4>Configuration<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><pre>[PluginSkipper]
filterfile=/etc/fuglu/skipplugins.regex</pre>
</div>
</div>
</div>
<div class="section" id="messagedebugger-debug">
<h3>MessageDebugger(debug)<a class="headerlink" href="#messagedebugger-debug" title="Permalink to this headline">¶</a></h3>
<p>Plugin: fuglu.plugins.p_debug.MessageDebugger</p>
<p>Message Debugger Plugin (Prepender).</p>
<p>This plugin enables the fuglu_debug functionality. Make sure fuglu listens on the debug port configured here.</p>
<div class="section" id="id11">
<h4>Configuration<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><pre>[MessageDebugger]
#messages incoming on this port will be debugged to a logfile
Make sure the debugport is also set in the incomingport configuration option in the main section
debugport=10888
#debug log output
debugfile=/tmp/fuglu_debug.log
#don't re-inject debugged messages back to postfix
noreinject=1
#debugged message can not be bounced
nobounce=1
#don't run appender plugins for debugged messages
noappender=1</pre>
</div>
</div>
</div>
</div>
<div class="section" id="writing-your-own-plugins">
<h2>Writing your own plugins<a class="headerlink" href="#writing-your-own-plugins" title="Permalink to this headline">¶</a></h2>
<p>Assuming you know python basics, writing plugins for fuglu is very easy. All you have to do is create a new class which extends from <tt class="docutils literal"><span class="pre">ScannerPlugin</span></tt>, override <tt class="docutils literal"><span class="pre">__str__</span></tt> to provide a nice human readable name and override <tt class="docutils literal"><span class="pre">examine</span></tt> to do the actual work of your plugins. <tt class="docutils literal"><span class="pre">examine</span></tt> should return one of the action codes above (DUNNO, DEFER, DELETE, ....). You probably only need stuff from <tt class="docutils literal"><span class="pre">fuglu.shared</span></tt>, so it&#8217;s probably a good idea to get familiar with that module.</p>
<p>This is a quick example of how your plugin code skeleton would look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">fuglu.shared</span> <span class="kn">import</span> <span class="n">ScannerPlugin</span><span class="p">,</span><span class="n">DUNNO</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">DemoPlugin</span><span class="p">(</span><span class="n">ScannerPlugin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copy this to make a new plugin&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">section</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">ScannerPlugin</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">section</span><span class="p">)</span>
        <span class="c">#config example</span>
        <span class="c">#self.requiredvars={</span>
        <span class="c">#    &#39;maxsize&#39;:{</span>
        <span class="c">#        &#39;default&#39;:&#39;1337&#39;,</span>
        <span class="c">#        &#39;description&#39;:&#39;Maximum message size&#39;,</span>
        <span class="c">#    }</span>
        <span class="c">#}</span>

    <span class="k">def</span> <span class="nf">examine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">suspect</span><span class="p">):</span>
        <span class="c">#config Example</span>
        <span class="c">#maxsize=self.config.getint(self.section, &#39;maxsize&#39;)</span>

        <span class="c">#debug example</span>
        <span class="c">#self._logger().debug(&#39;hello world from StubPlugin&#39;)</span>

        <span class="n">starttime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


        <span class="c">#PUT PLUGIN CODE HERE</span>

        <span class="c">#For debugging, its good to know how long each plugin took</span>
        <span class="n">endtime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">difftime</span><span class="o">=</span><span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
        <span class="n">suspect</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;DemoPlugin.time&#39;</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%.4f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">difftime</span>
        <span class="k">return</span> <span class="n">DUNNO</span>
</pre></div>
</div>
<p>First of all, you need a few imports. ScannerPlugin (so you can extend from it), and possible return values for your Plugin, DUNNO might be enough depending on what your plugin does.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">fuglu.shared</span> <span class="kn">import</span> <span class="n">ScannerPlugin</span><span class="p">,</span><span class="n">DUNNO</span>
</pre></div>
</div>
<p>in __init__ you only call BasicPlugins __init__  for now. This sets self.config and self.section on the object where you later can read config options (eg. self.config.get(self.section,&#8217;somevalue&#8217;).  Do NOT load the plugin configuration here. __init__ is only called once when fuglu starts up. Always load plugin config in <tt class="docutils literal"><span class="pre">examine</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">section</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">ScannerPlugin</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">section</span><span class="p">)</span>
</pre></div>
</div>
<p>then code your <tt class="docutils literal"><span class="pre">examine</span></tt> method. You will have to work with the <tt class="docutils literal"><span class="pre">suspect</span></tt> (TODO: LINK HERE) object, which is a representation of the message being analyzed. The suspect has <tt class="docutils literal"><span class="pre">tags</span></tt> that are read and written by plugins. You can tag a message as virus, as spam, define your own tags, read tags from previous plugins...  it&#8217;s probably a good idea to read FugluSuspect to get a list of things you can do with the suspect and FugluTags so see common tags that can have a influence on fuglu&#8217;s behaviour.</p>
<div class="section" id="common-tasks-api-faq">
<h3>Common Tasks (&#8220;API&#8221; FAQ)<a class="headerlink" href="#common-tasks-api-faq" title="Permalink to this headline">¶</a></h3>
<div class="section" id="define-configuration-options-for-your-plugin">
<h4>define configuration options for your plugin<a class="headerlink" href="#define-configuration-options-for-your-plugin" title="Permalink to this headline">¶</a></h4>
<p>in order to make &#8216;lint&#8217; and &#8216;fuglu_conf&#8217; work with your plugin it should tell the core what config options it expects. this is done by creating a dictionary named &#8216;requiredvars&#8217; in the plugins init:</p>
<p>Example:</p>
<div class="highlight-python"><pre>def __init__(self,config,section=None):
        ScannerPlugin.__init__(self,config,section)
        self.requiredvars={
            'host':{
                'default':'localhost',
                'description':'hostname',
            },

            'username':{
                'default':'root',
            },

            'password':{
                'default':``,
                'confidential':True,
            },

       }</pre>
</div>
<p>This would tell fuglu that your plugin has three config options: host, username and password.</p>
<p>The &#8216;dict of dicts&#8217; uses your config option name as key for the outer dict. The inner dict supports the following keys:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">default</span></tt> - Default value, used if the option is not specified in the config file</li>
<li><tt class="docutils literal"><span class="pre">section</span></tt> - config section to check. by default fuglu assumes that the plugin reads its own config section. override this if your plugin requires a config option from a different plugin or from the main config</li>
<li><tt class="docutils literal"><span class="pre">confidential</span></tt> - set this to True if fuglu_conf should treat this option confidential and redact it in &#8216;fuglu_conf -n&#8217; (passwords etc)</li>
<li><tt class="docutils literal"><span class="pre">validator</span></tt> - function that should be called to validate if the configured value is valid. the function will receive the value as argument and must return True or False</li>
<li><tt class="docutils literal"><span class="pre">deprecated</span></tt> - mark a config option as deprecated</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="read-the-config">
<h4>read the config<a class="headerlink" href="#read-the-config" title="Permalink to this headline">¶</a></h4>
<p>Configs in fuglu are stored in <tt class="docutils literal"><span class="pre">/etc/fuglu/fuglu.conf</span></tt> (or any .conf file in /etc/fuglu/conf.d ) in ini-style format. Your plugin gets its own Section named like the Plugin Class.</p>
<p>example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">DemoPlugin</span><span class="p">]</span>
<span class="n">maxsize</span><span class="o">=</span><span class="mi">10382</span>
</pre></div>
</div>
<p>you can then read the config in your plugin with the usual methods from a python ConfigParser object ( <a class="reference external" href="http://docs.python.org/library/configparser.html">http://docs.python.org/library/configparser.html</a> )</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">maxsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="s">&#39;maxsize&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Important: always the configs in <tt class="docutils literal"><span class="pre">examine</span></tt> (and not in <tt class="docutils literal"><span class="pre">init</span></tt> !). reading the config in init breaks loading default values and prevents on-the-fly config reload</p>
</div>
<div class="section" id="get-the-message-source">
<h4>get the message source<a class="headerlink" href="#get-the-message-source" title="Permalink to this headline">¶</a></h4>
<p>use <tt class="docutils literal"><span class="pre">suspect.getSource()</span></tt> to get the message source. The maxbytes option allows you to get only a part of the source. Reading the whole source can slow down scanning of big messages.</p>
<p>from fuglu.shared import ScannerPlugin,DUNNO
import time
add headers
&#8212;&#8212;&#8212;&#8211;</p>
<p><tt class="docutils literal"><span class="pre">suspect.addheader(headername,headervalue)</span></tt></p>
<p>by default, headers are added to the message shortly before it is re-injected into postfix.
add <tt class="docutils literal"><span class="pre">immediate=True</span></tt> to add the header immediately, so other plugins can see it.</p>
</div>
<div class="section" id="write-to-the-log">
<h4>write to the log<a class="headerlink" href="#write-to-the-log" title="Permalink to this headline">¶</a></h4>
<p>your plugin has a _logger method that returns a standard python logger object, so you can use the info / debug / error / fatal methods.</p>
<p>Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;hello world from DemoPlugin&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="write-debug-info">
<h4>write debug info<a class="headerlink" href="#write-debug-info" title="Permalink to this headline">¶</a></h4>
<p>to make the plugin write special debug info when <tt class="docutils literal"><span class="pre">fuglu_debug</span></tt> is used, use:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">suspect</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;debug info from DemoPlugin!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="make-plugin-lint-able">
<h4>make plugin &#8216;&#8211;lint&#8217;-able<a class="headerlink" href="#make-plugin-lint-able" title="Permalink to this headline">¶</a></h4>
<p>by default, <tt class="docutils literal"><span class="pre">lint()</span></tt> only validates the plugin&#8217;s configuration settings from <tt class="docutils literal"><span class="pre">self.requiredvars</span></tt>. You can override <tt class="docutils literal"><span class="pre">lint()</span></tt> to do more stuff.</p>
<blockquote>
<div><ul class="simple">
<li>use simple <tt class="docutils literal"><span class="pre">print</span></tt> in this method, no logging stuff.</li>
<li>if you override <tt class="docutils literal"><span class="pre">lint()</span></tt> you should run <tt class="docutils literal"><span class="pre">self.checkConfig()</span></tt> to test the configuration</li>
<li><tt class="docutils literal"><span class="pre">lint()</span></tt> must return True or False</li>
</ul>
</div></blockquote>
<p>example of a plugin that would check if an imap account is available:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">lint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">allok</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkConfig</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lint_imap</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">allok</span>

<span class="k">def</span> <span class="nf">lint_imap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">M</span><span class="o">=</span><span class="n">imaplib</span><span class="o">.</span><span class="n">IMAP4</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="s">&#39;host&#39;</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">type</span><span class="p">,</span><span class="n">data</span><span class="p">)</span><span class="o">=</span><span class="n">M</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="s">&#39;password&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">type</span><span class="o">!=</span><span class="s">&#39;OK&#39;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Could not login to imap review account: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Could not login to imap host:</span><span class="si">%s</span><span class="s"> - Error </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;StubPlugin&#39;</span><span class="p">,</span> <span class="s">&#39;host&#39;</span><span class="p">),</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</div>
</div>
<div class="section" id="use-the-suspectfilter">
<h4>use the &#8216;SuspectFilter&#8217;<a class="headerlink" href="#use-the-suspectfilter" title="Permalink to this headline">¶</a></h4>
<p>SuspectFilters are a common way for all plugins to perform an action based on conditions defined in a filterfile . These files are automatically re-loaded if changed.</p>
<blockquote>
<div><ul class="simple">
<li>import SuspectFilter from fuglu.shared</li>
<li>define a config variable for your plugin which holds the name of the filter file (not strictly required, you could hardcode the path)</li>
<li>create a plugin property for the filter</li>
</ul>
</div></blockquote>
<div class="highlight-python"><pre>from fuglu.shared import ScannerPlugin,SuspectFilter
[...]

class MyPlugin(ScannerPlugin):
    def __init__(self,config,section=None):
        ScannerPlugin.__init__(self,config,section)

        self.requiredvars={
            'myrulesfile':{
                'default':'/etc/fuglu/mypluginrules.regex',
                'description':'Filter file for my plugin',
            },

           [...]
        }
        self.filter=None</pre>
</div>
<p>in <tt class="docutils literal"><span class="pre">examine</span></tt> create the filter if necessary</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">=</span><span class="n">SuspectFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="s">&#39;myrulesfile&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>run the filter in examine: <tt class="docutils literal"><span class="pre">(match,arg)=self.filter.matches(suspect)</span></tt>
<tt class="docutils literal"><span class="pre">match</span></tt> is a boolean, telling you if one of the rules matched
<cite>arg`</cite> is an additional argument which have been appended to the filter rule in the config. lets say, the filter rule reads <tt class="docutils literal"><span class="pre">to_address</span> <span class="pre">example&#64;fuglu.org</span> <span class="pre">hello</span> <span class="pre">world!</span></tt>, you would get match=True and arg=&#8217;Hello world!&#8217; if the message is sent to <a class="reference external" href="mailto:example&#37;&#52;&#48;fuglu&#46;org">example<span>&#64;</span>fuglu<span>&#46;</span>org</a></p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">match</span><span class="p">,</span><span class="n">arg</span><span class="p">)</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">suspect</span><span class="p">)</span>
<span class="k">if</span> <span class="n">match</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">arg</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;&quot;&quot;we got a match with arg </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;&quot;&quot;We got a match without an arg&quot;&quot;&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">suspect</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;no rule matches&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="use-the-sql-extension">
<h4>use the sql extension<a class="headerlink" href="#use-the-sql-extension" title="Permalink to this headline">¶</a></h4>
<p>TODO (DBFiles, sqlalchemy connections)</p>
</div>
</div>
<div class="section" id="debugging">
<h3>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h3>
<div class="section" id="get-a-stacktrace">
<h4>get a stacktrace<a class="headerlink" href="#get-a-stacktrace" title="Permalink to this headline">¶</a></h4>
<p>if something went wrong you should see a stacktrace in the fuglu log (/var/log/fuglu/fuglu.log)
with fuglu &gt;=0.6.0 you can also get the most recent exceptions with the following command:</p>
<div class="highlight-python"><pre>fuglu_control exceptionlist</pre>
</div>
</div>
<div class="section" id="debug-the-plugin-while-fuglu-is-runnig">
<h4>debug the plugin while fuglu is runnig<a class="headerlink" href="#debug-the-plugin-while-fuglu-is-runnig" title="Permalink to this headline">¶</a></h4>
<p>run <tt class="docutils literal"><span class="pre">fuglu</span> <span class="pre">--console</span></tt> to enter an interactive python console after fuglu startup. Your plugin is then available via the list <tt class="docutils literal"><span class="pre">mc.plugins</span></tt></p>
</div>
<div class="section" id="debug-a-plugin-without-running-fuglu">
<h4>debug a plugin without running fuglu<a class="headerlink" href="#debug-a-plugin-without-running-fuglu" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">plugdummy.py</span></tt> is a tool that makes plugin development and testing much easier by creating a minimal fuglu environment for the plugin to run. it doesn&#8217;t require a running fuglu or postfix. it will create a dummy suspect, call the plugin&#8217;s examine method and print the result (and debug output).</p>
<p>the generated input messag is stored as: <tt class="docutils literal"><span class="pre">/tmp/fuglu_dummy_message_in.eml</span></tt></p>
<p>if your plugin modified the message source, the resulting message can be found at <tt class="docutils literal"><span class="pre">/tmp/fuglu_dummy_message_out.eml</span></tt></p>
<p><tt class="docutils literal"><span class="pre">plugdummy.py</span></tt> is located in the <tt class="docutils literal"><span class="pre">test</span></tt> directory.</p>
<p>simple usage:</p>
<p>assuming your plugin file (&#8216;myplugin.py&#8217;) is in <tt class="docutils literal"><span class="pre">/usr/local/fuglu/plugins</span></tt> you can run <tt class="docutils literal"><span class="pre">plugdummy.py</span> <span class="pre">&lt;pluginname&gt;</span></tt></p>
<div class="highlight-python"><pre>#./plugdummy.py myplugin.ExamplePlugin

INFO:root:Input file created as /tmp/fuglu_dummy_message_in.eml
INFO:root:Running plugin: ExamplePlugin
INFO:fuglu.plugin.ExamplePlugin:sender@fuglu.local greets recipient@fuglu.local: hello world!
INFO:root:Result: DUNNO
INFO:root:Suspect a7babc1e4cfe49c36710065966e6ed0a: from=sender@fuglu.local to=recipient@fuglu.local size=231 spam=no virus=no modified=no tags={'virus': {}, 'spam': {}, 'ExamplePlugin.time': '0.0001', 'highspam': {}}</pre>
</div>
<p>advanced usage:</p>
<p>run <tt class="docutils literal"><span class="pre">plugdummy.py</span> <span class="pre">--help</span></tt> to get a list of all options</p>
<p>Examples:</p>
<p>running plugins from a different directory</p>
<div class="highlight-python"><pre>./plugdummy.py -p /tmp/ myplugin.ExamplePlugin</pre>
</div>
<p>change sender / recipient
the &#8216;-s&#8217; and &#8216;-f&#8217; options change the envelope sender/recipient. -r can be specified multiple times to simulate a multi-recipient message</p>
<div class="highlight-python"><pre>./plugdummy.py -s me@example.org -r you@example.net  myplugin.ExamplePlugin
INFO:root:Input file created as /tmp/fuglu_dummy_message_in.eml
INFO:root:Running plugin: ExamplePlugin
INFO:fuglu.plugin.ExamplePlugin:me@example.org greets you@example.net: hello world!
INFO:root:Result: DUNNO
INFO:root:Suspect 423e02e1461cd1c314ac9a409176c4f4: from=me@example.org to=you@example.net size=221 spam=no virus=no modified=no tags={'virus': {}, 'spam': {}, 'ExamplePlugin.time': '0.0001', 'highspam': {}}</pre>
</div>
<p>adding headers to the input message</p>
<div class="highlight-python"><pre>./plugdummy.py -h 'subject:yo! whassup' myplugin.ExamplePlugin
[...]
cat /tmp/fuglu_dummy_message_in.eml
Content-Type: text/plain; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
From: sender@fuglu.local
To: recipient@fuglu.local
Subject: yo! whassup
Date: Fri, 01 Jun 2012 12:58:34 -0000

hello, world!</pre>
</div>
<p>adding tags:</p>
<div class="highlight-python"><pre>./plugdummy.py -t 'mytag:myvalue' myplugin.ExamplePlugin
INFO:root:Input file created as /tmp/fuglu_dummy_message_in.eml
INFO:root:Running plugin: ExamplePlugin
INFO:fuglu.plugin.ExamplePlugin:sender@fuglu.local greets recipient@fuglu.local: hello world!
INFO:root:Result: DUNNO
INFO:root:Suspect 168268d6ff2c2748454183efcb554242: from=sender@fuglu.local to=recipient@fuglu.local size=231 spam=no virus=no modified=no tags={'spam': {}, 'virus': {}, 'mytag': 'myvalue', 'ExamplePlugin.time': '0.0001', 'highspam': {}}</pre>
</div>
<p>setting a config option:</p>
<div class="highlight-python"><pre>./plugdummy.py -o 'greeting:go away!'  myplugin.ExamplePlugin
INFO:root:Input file created as /tmp/fuglu_dummy_message_in.eml
INFO:root:Running plugin: ExamplePlugin
INFO:fuglu.plugin.ExamplePlugin:sender@fuglu.local greets recipient@fuglu.local: go away!
[...]</pre>
</div>
<p>setting the message body:</p>
<div class="highlight-python"><pre>#set body
./plugdummy.py -b 'hi there, whassup!' myplugin.ExamplePlugin

#read body from file
./plugdummy.py -b bla.txt myplugin.ExamplePlugin

#read headers &amp; body from eml file
./plugdummy.py -e /tmp/bla.eml myplugin.ExamplePlugin</pre>
</div>
<p>running a interactive console in the dummy enrivonment:</p>
<div class="highlight-python"><pre>./plugdummy.py -c  myplugin.ExamplePlugin
INFO:root:Input file created as /tmp/fuglu_dummy_message_in.eml
INFO:root:Running plugin: ExamplePlugin
INFO:fuglu.plugin.ExamplePlugin:sender@fuglu.local greets recipient@fuglu.local: hello world!
INFO:root:Result: DUNNO
INFO:root:Suspect 3cf496cbe2a1097abc37ebda5a645cd2: from=sender@fuglu.local to=recipient@fuglu.local size=231 spam=no virus=no modified=no tags={'virus': {}, 'spam': {}, 'ExamplePlugin.time': '0.0001', 'highspam': {}}
Fuglu Interactive Console started

pre-defined locals:
{'config': &lt;ConfigParser.ConfigParser instance at 0x1ac9e60&gt;, 'suspect': &lt;fuglu.shared.Suspect object at 0x1ac8750&gt;, 'result': 0, 'plugin': &lt;myplugin.ExamplePlugin object at 0x1ac8290&gt;}

&gt;&gt;&gt; plugin.requiredvars
{'greeting': {'default': 'hello world!', 'description': 'greeting the plugin should log to the console'}}
&gt;&gt;&gt; plugin.examine(suspect)
INFO:fuglu.plugin.ExamplePlugin:sender@fuglu.local greets recipient@fuglu.local: hello world!
0
&gt;&gt;&gt; config.set('ExamplePlugin','greeting','Greetings, Earthling')
&gt;&gt;&gt; suspect.from_address='me@example.org'
&gt;&gt;&gt; plugin.examine(suspect)
INFO:fuglu.plugin.ExamplePlugin:me@example.org greets recipient@fuglu.local: Greetings, Earthling
0
&gt;&gt;&gt;</pre>
</div>
</div>
</div>
<div class="section" id="deploying-plugins">
<h3>Deploying Plugins<a class="headerlink" href="#deploying-plugins" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>if there is no <tt class="docutils literal"><span class="pre">plugindir</span></tt> set in fuglu.conf yet, define a new directory for custom plugins. eg <tt class="docutils literal"><span class="pre">/usr/local/fuglu/plugins</span></tt>.</li>
<li>copy your plugin file to this directory</li>
<li>depending on the type of your plugin, add it to the plugin/prependers/appenders config option. Eg. if your scanner plugin class is <tt class="docutils literal"><span class="pre">MyHeloPlugin</span></tt> in the file myplugin.py you would add <tt class="docutils literal"><span class="pre">myplugin.MyHeloPlugin</span></tt> to the <tt class="docutils literal"><span class="pre">plugins</span></tt> config</li>
<li>if your plugin reads configuration entries, make sure those are present in fuglu.conf or in a custom conf-file in /etc/fuglu/conf.d</li>
<li>run <tt class="docutils literal"><span class="pre">fuglu</span> <span class="pre">--lint</span></tt> to check if fuglu is happy with your new plugin</li>
<li>(re)start fuglu</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="unit-tests">
<h3>Unit Tests<a class="headerlink" href="#unit-tests" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>You can easily integrate your unittests with the fuglu test script.</dt>
<dd><ul class="first last simple">
<li>create your testcase in the same file as your plugin resides (the testscript will search for all classes extending unittest.TestCase</li>
<li>create a new directory &#8216;~/fuglu-dev&#8217;</li>
<li>in ~/fuglu-dev create a new textfile &#8216;&#8217;test.conf&#8217;&#8216;</li>
</ul>
</dd>
</dl>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">test</span><span class="p">]</span>
<span class="n">includemodules</span><span class="o">=</span><span class="n">myplugin</span>
</pre></div>
</div>
<p>(replace myplugin with your plugin module name)</p>
<blockquote>
<div><ul class="simple">
<li>create a symlink in fuglu-dev to your real plugin file, eg &#8216;&#8217;ln -s /home/edgar/work/myplugin/myplugin.py ~/fuglu-dev/myplugin.py&#8217;&#8216;</li>
<li>checkout the fuglu code from svn</li>
<li>cd to the test directory, then run the testscript with the modulename of your plugin as argument</li>
</ul>
</div></blockquote>
<div class="highlight-python"><pre>edgar@boscos:~/workspace/fuglu/test$ ./runtests.py myplugin
['../conf/fuglu.conf.dist', '/home/edgar/fuglu-dev/test.conf']
found 1 tests in myplugin
---------------------------
Total 1 tests in Testsuite

STARTING TESTS

fuglu.plugin.MyHeloPlugin: INFO     Hello world from sender@unittests.fuglu.org to recipient@unittests.fuglu.org!
.
----------------------------------------------------------------------
Ran 1 test in 0.010s

OK

Debug Output written to:/tmp/fuglu-test.log</pre>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Plugins</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#types-of-plugins">Types of plugins</a><ul>
<li><a class="reference internal" href="#scanner-plugins">Scanner Plugins</a></li>
<li><a class="reference internal" href="#prepender-plugins">Prepender Plugins</a></li>
<li><a class="reference internal" href="#appender-plugins">Appender Plugins</a></li>
</ul>
</li>
<li><a class="reference internal" href="#plugin-configuration">Plugin configuration</a><ul>
<li><a class="reference internal" href="#suspect-filters">Suspect Filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#plugins-included-in-fuglu">Plugins included in Fuglu</a><ul>
<li><a class="reference internal" href="#saplugin">SAPlugin</a><ul>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#clamavplugin">ClamavPlugin</a><ul>
<li><a class="reference internal" href="#id1">Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#attachment-blocker">Attachment Blocker</a><ul>
<li><a class="reference internal" href="#id2">Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#archiveplugin">ArchivePlugin</a><ul>
<li><a class="reference internal" href="#id3">Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#vacationplugin">VacationPlugin</a><ul>
<li><a class="reference internal" href="#id4">Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ssspplugin">SSSPPlugin</a><ul>
<li><a class="reference internal" href="#id5">Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#f-prot-plugin">F-Prot Plugin</a><ul>
<li><a class="reference internal" href="#id6">Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#icapplugin">ICAPPlugin</a><ul>
<li><a class="reference internal" href="#id7">Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#headerplugin">HeaderPlugin</a><ul>
<li><a class="reference internal" href="#id8">Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#actionoverrideplugin">ActionOverridePlugin</a><ul>
<li><a class="reference internal" href="#id9">Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pluginskipper">PluginSkipper</a><ul>
<li><a class="reference internal" href="#id10">Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#messagedebugger-debug">MessageDebugger(debug)</a><ul>
<li><a class="reference internal" href="#id11">Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#writing-your-own-plugins">Writing your own plugins</a><ul>
<li><a class="reference internal" href="#common-tasks-api-faq">Common Tasks (&#8220;API&#8221; FAQ)</a><ul>
<li><a class="reference internal" href="#define-configuration-options-for-your-plugin">define configuration options for your plugin</a></li>
<li><a class="reference internal" href="#read-the-config">read the config</a></li>
<li><a class="reference internal" href="#get-the-message-source">get the message source</a></li>
<li><a class="reference internal" href="#write-to-the-log">write to the log</a></li>
<li><a class="reference internal" href="#write-debug-info">write debug info</a></li>
<li><a class="reference internal" href="#make-plugin-lint-able">make plugin &#8216;&#8211;lint&#8217;-able</a></li>
<li><a class="reference internal" href="#use-the-suspectfilter">use the &#8216;SuspectFilter&#8217;</a></li>
<li><a class="reference internal" href="#use-the-sql-extension">use the sql extension</a></li>
</ul>
</li>
<li><a class="reference internal" href="#debugging">Debugging</a><ul>
<li><a class="reference internal" href="#get-a-stacktrace">get a stacktrace</a></li>
<li><a class="reference internal" href="#debug-the-plugin-while-fuglu-is-runnig">debug the plugin while fuglu is runnig</a></li>
<li><a class="reference internal" href="#debug-a-plugin-without-running-fuglu">debug a plugin without running fuglu</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deploying-plugins">Deploying Plugins</a></li>
<li><a class="reference internal" href="#unit-tests">Unit Tests</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="operation-index.html"
                        title="previous chapter">Operation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="help-index.html"
                        title="next chapter">Support</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/plugins-index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="help-index.html" title="Support"
             >next</a> |</li>
        <li class="right" >
          <a href="operation-index.html" title="Operation"
             >previous</a> |</li>
        <li><a href="index.html">fuglu 1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, gryphius.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>