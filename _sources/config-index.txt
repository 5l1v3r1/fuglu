Configuration
=============

Contents:

.. toctree::
   :maxdepth: 2


-------------------
Basic Configuration
-------------------

Fuglu
.....

First of all, rename remove the .dist ending from all files in ``/etc/fuglu``, so you have a basic default configuration.

edit ``/etc/fuglu/fuglu.conf`` and change parameters if you like

Note: If you don't have Clamav (clamd) or Spamassassin (spamd) , you need to remove those entries from the plugins option.

eg, change

::

	plugins=archive,attachment,clamav,spamassassin

to

::

	plugins=archive,attachment

to disable both Antispam and Antivirus. 



Make sure the logging directory exists:

::


	mkdir -p /var/log/fuglu
	chown nobody /var/log/fuglu


Then check if fuglu is happy with your configuration:


::

	fuglu --lint


example:

::


	fuglu --lint                                                 

	Fuglu $Id: core.py 7 2009-04-09 06:51:25Z oli $                                          
	---------- LINT MODE ----------                                                          
	Loading plugins...                                                                       
	Plugin loading complete                                                                  
	Linting  main configuration                                                              
	OK                                                                                       

	Linting Plugin  ArchivePlugin
	OK

	Linting Plugin  Attachment Blocker
	OK

	Linting Plugin  ClamavPlugin
	Got Pong: PONG

	Clamav found virus {'stream': 'Eicar-Test-Signature FOUND'}
	OK

	Linting Plugin  SAPlugin
	Got: SPAMD/1.4 0 PONG

	GTUBE Has been detected correctly
	OK

	Linting Plugin  MessageDebugger
	OK

	Linting Plugin  PluginSkipper
	OK

	0 plugins reported errors.



If all went fine, run ``fuglu`` without parameters to start the daemon. 
in ``/var/log/fuglu/fuglu.log`` you should then see output similar to this:

::

	tail /var/log/fuglu/fuglu.log
	2009-04-16 16:14:54,738 root        : INFO Dropping Privileges. Before: root(0)/root(0) After: nobody(99)/nobody(99)
	2009-04-16 16:14:54,739 fuglu.plugin.FiletypePlugin.RulesCache: INFO Loaded 0 rules from 2 files
	2009-04-16 16:14:54,739 fuglu.MainController: INFO Init Stat Engine
	2009-04-16 16:14:54,740 fuglu.MainController: INFO Init Threadpool
	2009-04-16 16:14:54,740 fuglu.MainController: INFO Init SMTP Engine
	2009-04-16 16:14:54,741 fuglu.MainController: INFO Startup complete
	2009-04-16 16:14:54,742 fuglu.smtp.incoming.10025: INFO SMTP Server running on port 10025
	2009-04-16 16:14:54,743 fuglu.smtp.incoming.10099: INFO SMTP Server running on port 10099
	2009-04-16 16:14:54,743 fuglu.smtp.incoming.10888: INFO SMTP Server running on port 10888



fuglu comes with a few example init scripts if you want to start fuglu like other system daemons




Postfix
.......

Once fuglu is up and running, we need to tell Postfix to use it as an after queue filter.

Detailed documentation is available on the `postfix <http://www.postfix.org/FILTER_README.html>`_ website, but here is a quick example. 

here is a quick example.

add to ``master.cf`` :


::

	#fuglu
	fuglu_default   unix  -       -       n       -       10      smtp
		-o smtp_send_xforward_command=yes
		-o disable_mime_output_conversion=yes

	fuglu_trusted   unix  -       -       n       -       10      smtp
		-o smtp_send_xforward_command=yes
		-o disable_mime_output_conversion=yes

	#
	localhost:10026 inet  n       -       n       -       10      smtpd
		-o content_filter=
		-o receive_override_options=no_unknown_recipient_checks,no_header_body_checks,no_milters,no_address_mappings
		-o smtpd_helo_restrictions=
		-o smtpd_client_restrictions=
		-o smtpd_sender_restrictions=
		-o smtpd_recipient_restrictions=permit_mynetworks,reject
		-o mynetworks=127.0.0.0/8
		-o smtpd_authorized_xforward_hosts=127.0.0.0/8


This creates two filters ``fuglu_trusted`` for outgoing mail and ``fuglu_default`` for incoming mail. An additional postfix instance will listen on port *10026* where fuglu can re-inject filtered messages.

create a new file ``/etc/postfix/filter_default``

::

	# filter for others
	/./ FILTER fuglu_default:[127.0.0.1]:10025


this tells postfix to send untrusted messages to fuglu on port 10025

create a new file ``/etc/postfix/filter_trusted``

::

	# filter for authenticated users 
	/./ FILTER fuglu_trusted:[127.0.0.1]:10099

this tells postfix to send trusted (outgoing) mail to fuglu on port 10099. Fuglu can be configured to treat outgoing mail differently, eg. skip spam scanning but keep antivirus scanning 

in ``main.cf`` add


::

	smtpd_recipient_restrictions = 	check_client_access pcre:/etc/postfix/filter_trusted,
									permit_sasl_authenticated,
									permit_mynetworks,
									reject_unauth_destination,
									pcre:/etc/postfix/filter_default

	fuglu_trusted_destination_recipient_limit=1
	fuglu_default_destination_recipient_limit=1



run ``postfix reload`` and check your maillog for errors. from now on, messages should be filtered by fuglu!

 



---------------
Advanced Config
---------------

text

Running a plugin multiple times with different config sections
..............................................................

By default, plugins search your configfile for a section named like the Plugin itself, for example, the ArchivePlugin looks for a [ArchivePlugin] section. This can be overridden which allows running plugin multiple times per scan with different config options:

example:

::

	plugins=archive(ArchiveConfig1),spamassassin,clamav,archive(ArchiveConfig2)

	[ArchiveConfig1]
	....

	[ArchiveConfig2]



Fuglu in Before-Queue Mode
..........................

The fuglu ESMTP Connector enables fuglu to run in before-queue mode, i.e. while the smtp session with the remote system is still active. This allows  rejecting spam / infected mails for example.


**Postfix config**:
edit ``master.cf`` as described in http://www.postfix.org/SMTPD_PROXY_README.html


::


    # Before-filter SMTP server. Receive mail from the network and
    # pass it to the content filter on localhost port 10025.
    #
    smtp      inet  n       -       n       -       20      smtpd
        -o smtpd_proxy_filter=127.0.0.1:10025
        -o smtpd_client_connection_count_limit=10
	# Postfix 2.7 and later performance feature.
	# -o smtpd_proxy_options=speed_adjust
    #
    # After-filter SMTP server. Receive mail from the content filter
    # on localhost port 10026.
    #
    127.0.0.1:10026 inet n  -       n       -        -      smtpd
        -o smtpd_authorized_xforward_hosts=127.0.0.0/8
        -o smtpd_client_restrictions=
        -o smtpd_helo_restrictions=
        -o smtpd_sender_restrictions=
        -o smtpd_recipient_restrictions=permit_mynetworks,reject
        -o smtpd_data_restrictions=
        -o mynetworks=127.0.0.0/8
        -o receive_override_options=no_unknown_recipient_checks

fuglu config:

enable the esmtp connector on the incoming port (10025) in ``/etc/fuglu/fuglu.conf``:

::

	incomingport=esmtp:10025,10099,10888


**rejecting spam**:

in the fuglu configuration set ``DEFAULTHIGHSPAMACTION=REJECT`` (do the same for ``DEFAULTLOWSPAMACTION`` if you want to reject all spam). in the Spamassassin Pluginconfiguration, you can configure a custom reject message which supports various template variables: 

 * *${from_address}* : sender address
 * *${to_address}* : recipient address
 * *${from_domain}* : sender domain
 * *${to_domain}* : recipient domain
 * *${subject}* : message subject
 * *${spamscore}* : spamassassin score
 * *${date}* : current date
 * *${time}* : current time 

Esample:

::

	rejectmessage=message from ${from_address} to ${to_domain} identified as spam (score=${spamscore})


**rejecting viruses**:

this works the same way as rejecting spam, by setting ``DEFAULTVIRUSACTION=REJECT`` and configuring the ``rejectmessage`` in the antivirus plugin section.



**Example fuglu configuration**

With this example pre-queue configuration fuglu will scan for spam, virus and blocked attachments. low spam will be tagged, high spam (level>=10) will be rejected. 

::

	[main]
	plugins=attachment,clamav,spamassassin
	incomingport=esmtp:10025,10099,10888

	[spam]
	DEFAULTLOWSPAMACTION=DUNNO
	DEFAULTHIGHSPAMACTION=REJECT

	[virus]
	DEFAULTVIRUSACTION=REJECT

	[FiletypePlugin]
	sendbounce=0
	blockaction=REJECT

	[SAPlugin]
	rejectmessage=Sorry, this message looks like spam to me!
	highspamlevel=10


Running fuglu as a milter
.........................

TODo










