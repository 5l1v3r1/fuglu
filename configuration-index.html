

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Configuration &#8212; fuglu  documentation</title>
    
    <link rel="stylesheet" href="_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="_static/cloud.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Operation" href="operation-index.html" />
    <link rel="prev" title="Installation" href="installation-index.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body role="document">
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="operation-index.html" title="Operation"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="installation-index.html" title="Installation"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="index.html">fuglu  documentation</a> &#187;</li>
 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="configuration">
<h1>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h1>
<p>Contents:</p>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="basic-configuration">
<h2>Basic Configuration<a class="headerlink" href="#basic-configuration" title="Permalink to this headline">¶</a></h2>
<div class="section" id="fuglu">
<h3>Fuglu<a class="headerlink" href="#fuglu" title="Permalink to this headline">¶</a></h3>
<p>First of all, remove the .dist ending from all files in <code class="docutils literal"><span class="pre">/etc/fuglu</span></code>, so you have a basic default configuration.</p>
<p>edit <code class="docutils literal"><span class="pre">/etc/fuglu/fuglu.conf</span></code> and change parameters if you like</p>
<p>Note: If you don&#8217;t have Clamav (clamd) or Spamassassin (spamd) , you need to remove those entries from the plugins option.</p>
<p>eg, change</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">plugins</span><span class="o">=</span><span class="n">archive</span><span class="p">,</span><span class="n">clamav</span><span class="p">,</span><span class="n">spamassassin</span><span class="p">,</span><span class="n">attachment</span>
</pre></div>
</div>
<p>to</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">plugins</span><span class="o">=</span><span class="n">archive</span><span class="p">,</span><span class="n">attachment</span>
</pre></div>
</div>
<p>to disable both Antispam and Antivirus.</p>
<p>Make sure the logging directory exists:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">fuglu</span>
<span class="n">chown</span> <span class="n">nobody</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">fuglu</span>
</pre></div>
</div>
<p>Then check if fuglu is happy with your configuration:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">fuglu</span> <span class="o">--</span><span class="n">lint</span>
</pre></div>
</div>
<p>example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">fuglu</span> <span class="o">--</span><span class="n">lint</span>
<span class="n">Fuglu</span> <span class="mf">0.6</span><span class="o">.</span><span class="mi">1</span>
<span class="o">----------</span> <span class="n">LINT</span> <span class="n">MODE</span> <span class="o">----------</span>
<span class="n">Checking</span> <span class="n">dependencies</span><span class="o">...</span>
<span class="n">sqlalchemy</span><span class="p">:</span> <span class="n">installed</span>
<span class="n">BeautifulSoup</span><span class="p">:</span> <span class="n">installed</span>
<span class="n">magic</span><span class="p">:</span> <span class="n">installed</span>
<span class="n">Loading</span> <span class="n">extensions</span><span class="o">...</span>
<span class="n">fuglu</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">sql</span><span class="p">:</span> <span class="n">enabled</span> <span class="p">(</span><span class="n">available</span><span class="p">)</span>
<span class="n">Loading</span> <span class="n">plugins</span><span class="o">...</span>
<span class="n">Plugin</span> <span class="n">loading</span> <span class="n">complete</span>
<span class="n">Linting</span>  <span class="n">main</span> <span class="n">configuration</span>
<span class="n">OK</span>

<span class="n">Linting</span> <span class="n">Plugin</span>  <span class="n">Archive</span> <span class="n">Config</span> <span class="n">section</span><span class="p">:</span> <span class="n">ArchivePlugin</span>
<span class="n">OK</span>

<span class="n">Linting</span> <span class="n">Plugin</span>  <span class="n">Attachment</span> <span class="n">Blocker</span> <span class="n">Config</span> <span class="n">section</span><span class="p">:</span> <span class="n">FiletypePlugin</span>
<span class="n">Found</span> <span class="n">python</span><span class="o">-</span><span class="n">file</span> <span class="n">magic</span> <span class="n">library</span>
<span class="n">No</span> <span class="n">database</span> <span class="n">configured</span><span class="o">.</span> <span class="n">Using</span> <span class="n">per</span> <span class="n">user</span><span class="o">/</span><span class="n">domain</span> <span class="n">file</span> <span class="n">configuration</span> <span class="kn">from</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fuglu</span><span class="o">/</span><span class="n">rules</span>
<span class="n">OK</span>

<span class="n">Linting</span> <span class="n">Plugin</span>  <span class="n">Clam</span> <span class="n">AV</span> <span class="n">Config</span> <span class="n">section</span><span class="p">:</span> <span class="n">ClamavPlugin</span>
<span class="n">Virusaction</span><span class="p">:</span> <span class="n">DELETE</span>
<span class="n">Got</span> <span class="n">Pong</span><span class="p">:</span> <span class="n">PONG</span>

<span class="n">Clamav</span> <span class="n">found</span> <span class="n">virus</span> <span class="p">{</span><span class="s1">&#39;stream&#39;</span><span class="p">:</span> <span class="s1">&#39;Eicar-Test-Signature&#39;</span><span class="p">}</span>
<span class="n">OK</span>

<span class="n">Linting</span> <span class="n">Plugin</span>  <span class="n">SpamAssassin</span> <span class="n">Config</span> <span class="n">section</span><span class="p">:</span> <span class="n">SAPlugin</span>
<span class="n">Got</span><span class="p">:</span> <span class="n">SPAMD</span><span class="o">/</span><span class="mf">1.5</span> <span class="mi">0</span> <span class="n">PONG</span>

<span class="n">GTUBE</span> <span class="n">Has</span> <span class="n">been</span> <span class="n">detected</span> <span class="n">correctly</span>
<span class="n">OK</span>

<span class="n">Linting</span> <span class="n">Plugin</span>  <span class="n">Debugger</span> <span class="n">Config</span> <span class="n">section</span><span class="p">:</span> <span class="n">debug</span>
<span class="n">OK</span>

<span class="n">Linting</span> <span class="n">Plugin</span>  <span class="n">Plugin</span> <span class="n">Skipper</span> <span class="n">Config</span> <span class="n">section</span><span class="p">:</span> <span class="n">PluginSkipper</span>
<span class="n">OK</span>
<span class="mi">0</span> <span class="n">plugins</span> <span class="n">reported</span> <span class="n">errors</span><span class="o">.</span>
</pre></div>
</div>
<p>If all went fine, run <code class="docutils literal"><span class="pre">fuglu</span></code> without parameters to start the daemon.
In <code class="docutils literal"><span class="pre">/var/log/fuglu/fuglu.log</span></code> you should then see output similar to this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">15</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">093</span> <span class="n">root</span>        <span class="p">:</span> <span class="n">INFO</span> <span class="n">FuGLU</span> <span class="n">Version</span> <span class="mf">0.6</span><span class="o">.</span><span class="mi">1</span> <span class="n">starting</span> <span class="n">up</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">15</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">094</span> <span class="n">fuglu</span><span class="o">.</span><span class="n">MainController</span><span class="p">:</span> <span class="n">INFO</span> <span class="n">Init</span> <span class="n">Stat</span> <span class="n">Engine</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">15</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">094</span> <span class="n">fuglu</span><span class="o">.</span><span class="n">MainController</span><span class="p">:</span> <span class="n">INFO</span> <span class="n">Init</span> <span class="n">Threadpool</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">15</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">095</span> <span class="n">fuglu</span><span class="o">.</span><span class="n">MainController</span><span class="p">:</span> <span class="n">INFO</span> <span class="n">Starting</span> <span class="n">interface</span> <span class="n">sockets</span><span class="o">...</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">15</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">095</span> <span class="n">fuglu</span><span class="o">.</span><span class="n">MainController</span><span class="p">:</span> <span class="n">INFO</span> <span class="n">starting</span> <span class="n">connector</span> <span class="n">smtp</span><span class="o">/</span><span class="mi">10025</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">15</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">096</span> <span class="n">fuglu</span><span class="o">.</span><span class="n">MainController</span><span class="p">:</span> <span class="n">INFO</span> <span class="n">starting</span> <span class="n">connector</span> <span class="n">smtp</span><span class="o">/</span><span class="mi">10099</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">15</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">096</span> <span class="n">fuglu</span><span class="o">.</span><span class="n">incoming</span><span class="o">.</span><span class="mi">10025</span><span class="p">:</span> <span class="n">INFO</span> <span class="n">SMTP</span> <span class="p">(</span><span class="n">After</span> <span class="n">Queue</span><span class="p">)</span> <span class="n">Server</span> <span class="n">running</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">10025</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">15</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">096</span> <span class="n">fuglu</span><span class="o">.</span><span class="n">MainController</span><span class="p">:</span> <span class="n">INFO</span> <span class="n">starting</span> <span class="n">connector</span> <span class="n">smtp</span><span class="o">/</span><span class="mi">10888</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">15</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">096</span> <span class="n">fuglu</span><span class="o">.</span><span class="n">incoming</span><span class="o">.</span><span class="mi">10099</span><span class="p">:</span> <span class="n">INFO</span> <span class="n">SMTP</span> <span class="p">(</span><span class="n">After</span> <span class="n">Queue</span><span class="p">)</span> <span class="n">Server</span> <span class="n">running</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">10099</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">15</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">097</span> <span class="n">fuglu</span><span class="o">.</span><span class="n">incoming</span><span class="o">.</span><span class="mi">10888</span><span class="p">:</span> <span class="n">INFO</span> <span class="n">SMTP</span> <span class="p">(</span><span class="n">After</span> <span class="n">Queue</span><span class="p">)</span> <span class="n">Server</span> <span class="n">running</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">10888</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">15</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">097</span> <span class="n">fuglu</span><span class="o">.</span><span class="n">MainController</span><span class="p">:</span> <span class="n">INFO</span> <span class="n">Startup</span> <span class="n">complete</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">15</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">097</span> <span class="n">fuglu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fuglu_control</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span> <span class="n">INFO</span> <span class="n">Control</span><span class="o">/</span><span class="n">Info</span> <span class="n">Server</span> <span class="n">running</span> <span class="n">on</span> <span class="n">port</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">fuglu_control</span><span class="o">.</span><span class="n">sock</span>
</pre></div>
</div>
<p>fuglu comes with init scripts/systemd service files if you want to start fuglu like other system daemons</p>
</div>
<div class="section" id="postfix">
<h3>Postfix<a class="headerlink" href="#postfix" title="Permalink to this headline">¶</a></h3>
<p>Once fuglu is up and running, we need to tell Postfix to use it as an after queue filter.</p>
<p>Detailed documentation is available on the <a class="reference external" href="http://www.postfix.org/FILTER_README.html">postfix</a> website, but here is a quick example.</p>
<p>Add to <code class="docutils literal"><span class="pre">master.cf</span></code> :</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#fuglu</span>
<span class="n">fuglu_default</span>   <span class="n">unix</span>  <span class="o">-</span>       <span class="o">-</span>       <span class="n">n</span>       <span class="o">-</span>       <span class="mi">10</span>      <span class="n">smtp</span>
        <span class="o">-</span><span class="n">o</span> <span class="n">smtp_send_xforward_command</span><span class="o">=</span><span class="n">yes</span>
        <span class="o">-</span><span class="n">o</span> <span class="n">disable_mime_output_conversion</span><span class="o">=</span><span class="n">yes</span>

<span class="n">fuglu_trusted</span>   <span class="n">unix</span>  <span class="o">-</span>       <span class="o">-</span>       <span class="n">n</span>       <span class="o">-</span>       <span class="mi">10</span>      <span class="n">smtp</span>
        <span class="o">-</span><span class="n">o</span> <span class="n">smtp_send_xforward_command</span><span class="o">=</span><span class="n">yes</span>
        <span class="o">-</span><span class="n">o</span> <span class="n">disable_mime_output_conversion</span><span class="o">=</span><span class="n">yes</span>

<span class="c1">#</span>
<span class="n">localhost</span><span class="p">:</span><span class="mi">10026</span> <span class="n">inet</span>  <span class="n">n</span>       <span class="o">-</span>       <span class="n">n</span>       <span class="o">-</span>       <span class="mi">10</span>      <span class="n">smtpd</span>
        <span class="o">-</span><span class="n">o</span> <span class="n">content_filter</span><span class="o">=</span>
        <span class="o">-</span><span class="n">o</span> <span class="n">receive_override_options</span><span class="o">=</span><span class="n">no_unknown_recipient_checks</span><span class="p">,</span><span class="n">no_header_body_checks</span><span class="p">,</span><span class="n">no_milters</span><span class="p">,</span><span class="n">no_address_mappings</span>
        <span class="o">-</span><span class="n">o</span> <span class="n">smtpd_helo_restrictions</span><span class="o">=</span>
        <span class="o">-</span><span class="n">o</span> <span class="n">smtpd_client_restrictions</span><span class="o">=</span>
        <span class="o">-</span><span class="n">o</span> <span class="n">smtpd_sender_restrictions</span><span class="o">=</span>
        <span class="o">-</span><span class="n">o</span> <span class="n">smtpd_recipient_restrictions</span><span class="o">=</span><span class="n">permit_mynetworks</span><span class="p">,</span><span class="n">reject</span>
        <span class="o">-</span><span class="n">o</span> <span class="n">mynetworks</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">8</span>
        <span class="o">-</span><span class="n">o</span> <span class="n">smtpd_authorized_xforward_hosts</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">8</span>
</pre></div>
</div>
<p>This creates two filters <code class="docutils literal"><span class="pre">fuglu_trusted</span></code> for outgoing mail and <code class="docutils literal"><span class="pre">fuglu_default</span></code> for incoming mail. An additional postfix instance will listen on port <em>10026</em> where fuglu can re-inject filtered messages.</p>
<p>Create a new file <code class="docutils literal"><span class="pre">/etc/postfix/filter_default</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># filter for others</span>
<span class="o">/./</span> <span class="n">FILTER</span> <span class="n">fuglu_default</span><span class="p">:[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]:</span><span class="mi">10025</span>
</pre></div>
</div>
<p>This tells postfix to send untrusted messages to fuglu on port 10025</p>
<p>Create a new file <code class="docutils literal"><span class="pre">/etc/postfix/filter_trusted</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># filter for authenticated users</span>
<span class="o">/./</span> <span class="n">FILTER</span> <span class="n">fuglu_trusted</span><span class="p">:[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]:</span><span class="mi">10099</span>
</pre></div>
</div>
<p>This tells postfix to send trusted (outgoing) mail to fuglu on port 10099. Fuglu can be configured to treat outgoing mail differently, eg. skip spam scanning but keep antivirus scanning</p>
<p>In <code class="docutils literal"><span class="pre">main.cf</span></code> add</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">smtpd_recipient_restrictions</span> <span class="o">=</span>  <span class="n">check_client_access</span> <span class="n">pcre</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">filter_trusted</span><span class="p">,</span>
                                                                <span class="n">permit_sasl_authenticated</span><span class="p">,</span>
                                                                <span class="n">permit_mynetworks</span><span class="p">,</span>
                                                                <span class="n">reject_unauth_destination</span><span class="p">,</span>
                                                                <span class="n">pcre</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">filter_default</span>

<span class="n">fuglu_trusted_destination_recipient_limit</span><span class="o">=</span><span class="mi">1</span>
<span class="n">fuglu_default_destination_recipient_limit</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>Run <code class="docutils literal"><span class="pre">postfix</span> <span class="pre">reload</span></code> and check your maillog for errors. from now on, messages should be filtered by fuglu!</p>
</div>
</div>
<div class="section" id="advanced-config">
<h2>Advanced Config<a class="headerlink" href="#advanced-config" title="Permalink to this headline">¶</a></h2>
<div class="section" id="running-a-plugin-multiple-times-with-different-config-sections">
<h3>Running a plugin multiple times with different config sections<a class="headerlink" href="#running-a-plugin-multiple-times-with-different-config-sections" title="Permalink to this headline">¶</a></h3>
<p>By default, plugins search your configfile for a section named like the
plugin itself, for example, the ArchivePlugin looks for a [ArchivePlugin] section. You can pass the plugin definition an argument to override this with a section named to suit your needs.
This can also allow running a plugin multiple times per scan with different config options:</p>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">plugins</span><span class="o">=</span><span class="n">archive</span><span class="p">(</span><span class="n">ArchiveConfig1</span><span class="p">),</span><span class="n">spamassassin</span><span class="p">,</span><span class="n">clamav</span><span class="p">,</span><span class="n">archive</span><span class="p">(</span><span class="n">ArchiveConfig2</span><span class="p">)</span>

<span class="p">[</span><span class="n">ArchiveConfig1</span><span class="p">]</span>
<span class="o">....</span>

<span class="p">[</span><span class="n">ArchiveConfig2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="fuglu-in-before-queue-mode">
<h3>Fuglu in Before-Queue Mode<a class="headerlink" href="#fuglu-in-before-queue-mode" title="Permalink to this headline">¶</a></h3>
<p>The fuglu ESMTP connector enables fuglu to run in before-queue mode, i.e. while the smtp session with the remote system is still active. This allows rejecting spam / infected mails.</p>
<p><strong>Postfix config</strong>:
edit <code class="docutils literal"><span class="pre">master.cf</span></code> as described in <a class="reference external" href="http://www.postfix.org/SMTPD_PROXY_README.html">http://www.postfix.org/SMTPD_PROXY_README.html</a></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Before-filter SMTP server. Receive mail from the network and</span>
<span class="c1"># pass it to the content filter on localhost port 10025.</span>
<span class="c1">#</span>
<span class="n">smtp</span>      <span class="n">inet</span>  <span class="n">n</span>       <span class="o">-</span>       <span class="n">n</span>       <span class="o">-</span>       <span class="mi">20</span>      <span class="n">smtpd</span>
    <span class="o">-</span><span class="n">o</span> <span class="n">smtpd_proxy_filter</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">10025</span>
    <span class="o">-</span><span class="n">o</span> <span class="n">smtpd_client_connection_count_limit</span><span class="o">=</span><span class="mi">10</span>
    <span class="c1"># Postfix 2.7 and later performance feature.</span>
    <span class="c1"># -o smtpd_proxy_options=speed_adjust</span>
<span class="c1">#</span>
<span class="c1"># After-filter SMTP server. Receive mail from the content filter</span>
<span class="c1"># on localhost port 10026.</span>
<span class="c1">#</span>
<span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">10026</span> <span class="n">inet</span> <span class="n">n</span>  <span class="o">-</span>       <span class="n">n</span>       <span class="o">-</span>        <span class="o">-</span>      <span class="n">smtpd</span>
    <span class="o">-</span><span class="n">o</span> <span class="n">smtpd_authorized_xforward_hosts</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">8</span>
    <span class="o">-</span><span class="n">o</span> <span class="n">smtpd_client_restrictions</span><span class="o">=</span>
    <span class="o">-</span><span class="n">o</span> <span class="n">smtpd_helo_restrictions</span><span class="o">=</span>
    <span class="o">-</span><span class="n">o</span> <span class="n">smtpd_sender_restrictions</span><span class="o">=</span>
    <span class="o">-</span><span class="n">o</span> <span class="n">smtpd_recipient_restrictions</span><span class="o">=</span><span class="n">permit_mynetworks</span><span class="p">,</span><span class="n">reject</span>
    <span class="o">-</span><span class="n">o</span> <span class="n">smtpd_data_restrictions</span><span class="o">=</span>
    <span class="o">-</span><span class="n">o</span> <span class="n">mynetworks</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">8</span>
    <span class="o">-</span><span class="n">o</span> <span class="n">receive_override_options</span><span class="o">=</span><span class="n">no_unknown_recipient_checks</span>
</pre></div>
</div>
<p>fuglu config:</p>
<p>Enable the esmtp connector on the incoming port (10025) in <code class="docutils literal"><span class="pre">/etc/fuglu/fuglu.conf</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">incomingport</span><span class="o">=</span><span class="n">esmtp</span><span class="p">:</span><span class="mi">10025</span><span class="p">,</span><span class="mi">10099</span><span class="p">,</span><span class="mi">10888</span>
</pre></div>
</div>
<p><strong>rejecting spam</strong>:</p>
<p>In the fuglu configuration set <code class="docutils literal"><span class="pre">DEFAULTHIGHSPAMACTION=REJECT</span></code> (do the same for <code class="docutils literal"><span class="pre">DEFAULTLOWSPAMACTION</span></code> if you want to reject all spam). in the Spamassassin Pluginconfiguration, you can configure a custom reject message which supports various template variables:</p>
<blockquote>
<div><ul class="simple">
<li><em>${from_address}</em> : sender address</li>
<li><em>${to_address}</em> : recipient address</li>
<li><em>${from_domain}</em> : sender domain</li>
<li><em>${to_domain}</em> : recipient domain</li>
<li><em>${subject}</em> : message subject</li>
<li><em>${spamscore}</em> : spamassassin score</li>
<li><em>${date}</em> : current date</li>
<li><em>${time}</em> : current time</li>
<li>As of fuglu 0.8.1, properties as documented in <a class="reference internal" href="plugins-index.html#suspect-filter"><span class="std std-ref">Suspect Filters</span></a> can be used as well</li>
</ul>
</div></blockquote>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>rejectmessage=message from ${from_address} to ${to_domain} identified as spam (score=${spamscore})
</pre></div>
</div>
<p><strong>rejecting viruses</strong>:</p>
<p>This works the same way as rejecting spam, by setting <code class="docutils literal"><span class="pre">DEFAULTVIRUSACTION=REJECT</span></code> and configuring the <code class="docutils literal"><span class="pre">rejectmessage</span></code> in the antivirus plugin section.</p>
<p><strong>Example fuglu configuration</strong></p>
<p>With this example pre-queue configuration fuglu will scan for spam, virus and blocked attachments. low spam will be tagged, high spam (level&gt;=10) will be rejected.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[main]
plugins=clamav,spamassassin,attachment
incomingport=esmtp:10025,10099,10888

[spam]
DEFAULTLOWSPAMACTION=DUNNO
DEFAULTHIGHSPAMACTION=REJECT

[virus]
DEFAULTVIRUSACTION=REJECT

[FiletypePlugin]
sendbounce=0
blockaction=REJECT

[SAPlugin]
rejectmessage=Sorry, this message looks like spam to me!
highspamlevel=10
</pre></div>
</div>
</div>
<div class="section" id="running-fuglu-as-a-milter">
<h3>Running fuglu as a milter<a class="headerlink" href="#running-fuglu-as-a-milter" title="Permalink to this headline">¶</a></h3>
<p>!! Warning, this is an EXPERIMENTAL feature - untested, may or may not work !!</p>
<p>!! Note: fuglu milter does not currently support message header/body modification, just actions like REJECT/DEFER/DISCARD !!</p>
<p>To run fuglu as a milter, add <code class="docutils literal"><span class="pre">milter:&lt;portnumber</span></code> to the <code class="docutils literal"><span class="pre">incomingport</span></code> configuration option in fuglu.conf.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">incomingport</span><span class="o">=</span><span class="mi">10025</span><span class="p">,</span><span class="mi">10099</span><span class="p">,</span><span class="mi">10888</span><span class="p">,</span><span class="n">milter</span><span class="p">:</span><span class="mi">10028</span>
</pre></div>
</div>
<p>Then enable milters in your MTA. postfix example (main.cf) :</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">milter_protocol</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">milter_default_action</span> <span class="o">=</span> <span class="n">accept</span>
<span class="n">milter_content_timeout</span> <span class="o">=</span> <span class="mi">30</span><span class="n">s</span>
<span class="n">smtpd_milters</span><span class="o">=</span><span class="n">inet</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">10028</span>
</pre></div>
</div>
</div>
<div class="section" id="running-fuglu-in-netcat-mode">
<h3>Running fuglu in netcat-mode<a class="headerlink" href="#running-fuglu-in-netcat-mode" title="Permalink to this headline">¶</a></h3>
<p>fuglu supports message processing by simply &#8220;piping&#8221; them into a socket. To enable this socket, add <code class="docutils literal"><span class="pre">netcat:&lt;portnumber&gt;</span></code> to the <code class="docutils literal"><span class="pre">incomingport</span></code> configuration option in fuglu.conf.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">incomingport</span><span class="o">=</span><span class="mi">10025</span><span class="p">,</span><span class="mi">10099</span><span class="p">,</span><span class="mi">10888</span><span class="p">,</span><span class="n">netcat</span><span class="p">:</span><span class="mi">20099</span>
</pre></div>
</div>
<p>When restarting fuglu, you should see something like <code class="docutils literal"><span class="pre">INFO</span> <span class="pre">NETCAT</span> <span class="pre">Server</span> <span class="pre">running</span> <span class="pre">on</span> <span class="pre">port</span> <span class="pre">20099</span></code> in the logs. you may then pipe an eml from the shell</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">sleep</span> <span class="mf">0.1</span><span class="p">;</span> <span class="n">cat</span> <span class="n">eicar</span><span class="o">.</span><span class="n">eml</span><span class="p">)</span> <span class="o">|</span> <span class="n">nc</span> <span class="o">-</span><span class="n">c</span> <span class="n">localhost</span> <span class="mi">20099</span>
</pre></div>
</div>
<p>In some special setups, people use fuglu as an after-delivery filter with this method.</p>
<p>Example procmail filter:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># netcat send msg copy to fuglu</span>
<span class="p">:</span><span class="mi">0</span><span class="n">c</span>
<span class="o">|</span> <span class="n">nc</span> <span class="n">localhost</span> <span class="mi">20099</span>
</pre></div>
</div>
<p>Note: in netcat mode fuglu only receives message headers and body, no envelope data. Fuglu will assign the dummy value <code class="docutils literal"><span class="pre">unknown&#64;example.org</span></code> for both envelope sender and recipient.</p>
</div>
<div class="section" id="fetching-scan-time-configuration-values-from-a-database">
<h3>Fetching scan-time configuration values from a database<a class="headerlink" href="#fetching-scan-time-configuration-values-from-a-database" title="Permalink to this headline">¶</a></h3>
<p>It is now possible to fetch certain configuration options at runtime, based on the recipient email address or domain.</p>
<p>For this to work you need to have sqlalchemy installed ( running <cite>fuglu &#8211;lint</cite> should show <cite>enabled</cite> for the sql extension)</p>
<p>SQL script to create the the table:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>CREATE TABLE `fugluconfig` (
  `scope` varchar(255) NOT NULL,
  `section` varchar(255) NOT NULL,
  `option` varchar(255) NOT NULL,
  `value` varchar(255) NOT NULL,
  PRIMARY KEY (`scope`,`section`,`option`)
)
</pre></div>
</div>
<p>The process is very similar to spamassassin&#8217;s SQL configuration  (<a class="reference external" href="http://wiki.apache.org/spamassassin/UsingSQL">http://wiki.apache.org/spamassassin/UsingSQL</a> ), with a few minor differences:</p>
<blockquote>
<div><ul class="simple">
<li>we require two columns to identify a preference: <cite>section</cite> and <cite>option</cite></li>
<li>username is called <cite>scope</cite></li>
<li>fuglu does not load the full configuration per user, only the actual config options requested by plugins supporting db overrides</li>
</ul>
</div></blockquote>
<p>Enable configuration lookups by providing a standard sql alchemy connectstring in your configuration (section <cite>databaseconfig</cite> option <cite>dbconnectstring</cite>)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">databaseconfig</span><span class="p">]</span>
<span class="n">dbconnectstring</span><span class="o">=</span><span class="n">mysql</span><span class="p">:</span><span class="o">//</span><span class="n">root</span><span class="nd">@localhost</span><span class="o">/</span><span class="n">fuglu</span>
</pre></div>
</div>
<p>If you use the above table structure in MariaDB / MySQl, the built-in default sql statement should work, but you may use a custom statement (<cite>sql=SELECT ....</cite> in the same section.  ) use <cite>:section</cite>, <cite>:option</cite> and the usual suspect variables like <cite>:to_domain</cite> and <cite>:to_address</cite> as placeholders.</p>
<dl class="docutils">
<dt>Note: only the following plugins currently supports reading database overrides for the listed options:</dt>
<dd><ul class="first last simple">
<li>Spamassassin: <cite>lowspamaction</cite>, <cite>highspamaction</cite>, <cite>highspamlevel</cite></li>
<li>FiletypePlugin: <cite>sendbounce</cite>, <cite>checkarchivenames</cite>, <cite>checkarchivecontent</cite>, <cite>enabledarchivetypes</cite></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="multi-processing-mode">
<h3>multi-processing mode<a class="headerlink" href="#multi-processing-mode" title="Permalink to this headline">¶</a></h3>
<p>by default, fuglu runs multi-threaded. This is usually a fine choice as many tasks are I/O-bound (waiting on sockets etc). However, for environments running CPU-bound tasks directly in fuglu plugins this can become a bottleneck. Due to the python global interpreter lock, only one operation can run at a time and fuglu does utilize only one CPU core.</p>
<p>For these setups, fuglu can be switched to multiprocessing mode:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">performance</span><span class="p">]</span>
<span class="n">backend</span><span class="o">=</span><span class="n">process</span>
<span class="n">initialprocs</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
<p><cite>initialprocs</cite> defines the number of worker processes that fuglu should start. If set to <cite>0</cite> , fuglu will default to twice the number of available virtual CPU cores.</p>
<dl class="docutils">
<dt>Most things will work similarly as in threaded mode, but there are a few differences:</dt>
<dd><ul class="first last simple">
<li>in threaded mode, there is only one instance per plugin. In multiprocessing there is one instance per worker. This means increased memory usage, as in-memory caches are built multiple times.</li>
<li>dynamic config reloading is not currently supported in multiprocessing mode. Restart fuglu for config changes to take effect.</li>
<li>the number of workers is not auto-adapted like in threading mode</li>
</ul>
</dd>
</dl>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="sphinx-toc sphinxlocaltoc">
    <h3><a href="index.html">Page contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Configuration</a><ul>
<li><a class="reference internal" href="#basic-configuration">Basic Configuration</a><ul>
<li><a class="reference internal" href="#fuglu">Fuglu</a></li>
<li><a class="reference internal" href="#postfix">Postfix</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-config">Advanced Config</a><ul>
<li><a class="reference internal" href="#running-a-plugin-multiple-times-with-different-config-sections">Running a plugin multiple times with different config sections</a></li>
<li><a class="reference internal" href="#fuglu-in-before-queue-mode">Fuglu in Before-Queue Mode</a></li>
<li><a class="reference internal" href="#running-fuglu-as-a-milter">Running fuglu as a milter</a></li>
<li><a class="reference internal" href="#running-fuglu-in-netcat-mode">Running fuglu in netcat-mode</a></li>
<li><a class="reference internal" href="#fetching-scan-time-configuration-values-from-a-database">Fetching scan-time configuration values from a database</a></li>
<li><a class="reference internal" href="#multi-processing-mode">multi-processing mode</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="installation-index.html"
                          title="Previous page">&larr; Installation</a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="operation-index.html"
                          title="Next page">&rarr; Operation</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/configuration-index.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="operation-index.html" title="Operation"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="installation-index.html" title="Installation"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="index.html">fuglu  documentation</a> &#187;</li>
 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2018, gryphius.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>