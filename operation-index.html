

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Operation &mdash; fuglu 1 documentation</title>
    
    <link rel="stylesheet" href="_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="_static/cloud.js"></script>
    <link rel="top" title="fuglu 1 documentation" href="index.html" />
    <link rel="next" title="Plugins" href="plugins-index.html" />
    <link rel="prev" title="Configuration" href="configuration-index.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="plugins-index.html" title="Plugins"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="configuration-index.html" title="Configuration"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="index.html">fuglu 1 documentation</a> &raquo;</li>
 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="operation">
<h1>Operation<a class="headerlink" href="#operation" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
<ul class="simple">
</ul>
</div>
<div class="section" id="monitoring">
<h2>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this headline">¶</a></h2>
<p>Fuglu has various places where you can see what it is is currently doing (eg. for debugging purposes) or what it has done (for statistical analysis)</p>
<div class="section" id="command-line-interface">
<h3>Command Line Interface<a class="headerlink" href="#command-line-interface" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">fuglu_control</span></tt> command offers various options to get real-time information on fuglu internals</p>
<p><strong>statistics:</strong></p>
<div class="highlight-python"><div class="highlight"><pre>#$ fuglu_control stats
Fuglu statistics
---------------
Uptime:         19:33:56.119661
Avg scan time:  3.9657
Total msgs:     86667
Ham:            547
Spam:           86124
Virus:          8
</pre></div>
</div>
<p><strong>Status of currently running scanner threads:</strong></p>
<div class="highlight-python"><div class="highlight"><pre>#fuglu_control workerlist
Total 10 Threads

[98]: Suspect 8790fa16a3733350baf02d5b4e7d98e1: from=&lt;redacted&gt; to=&lt;redacted&gt; size=1043 , spam=no, virus=no tags={&#39;virus&#39;: {&#39;F-Prot&#39;: False, &#39;ClamAV&#39;: False}, &#39;FprotPlugin.time&#39;: &#39;0.0080&#39;, &#39;spam&#39;: {}, &#39;incomingport&#39;: 10025, &#39;decisions&#39;: [(&#39;F-Prot Plugin&#39;, 0), (&#39;ClamavPlugin&#39;, 0)], &#39;ClamavPlugin.time&#39;: &#39;0.0055&#39;} : Running Plugin SAPlugin
*******
[99]: Suspect b6f3019df4da4170888e144f98eaa3ad: from=&lt;redacted&gt; to=&lt;redacted&gt; size=5187 , spam=no, virus=no tags={&#39;virus&#39;: {&#39;F-Prot&#39;: False, &#39;ClamAV&#39;: False}, &#39;FprotPlugin.time&#39;: &#39;0.0088&#39;, &#39;spam&#39;: {}, &#39;incomingport&#39;: 10025, &#39;decisions&#39;: [(&#39;F-Prot Plugin&#39;, 0), (&#39;ClamavPlugin&#39;, 0)], &#39;ClamavPlugin.time&#39;: &#39;0.0161&#39;} : Running Plugin SAPlugin
*******
[100]: waiting for task
*******
[101]: Suspect eefa38e4ae4a9c2938670a46d6b2b922: from=&lt;redacted&gt; to=&lt;redacted&gt; size=5203 , spam=no, virus=no tags={&#39;virus&#39;: {&#39;F-Prot&#39;: False, &#39;ClamAV&#39;: False}, &#39;FprotPlugin.time&#39;: &#39;0.0086&#39;, &#39;spam&#39;: {}, &#39;incomingport&#39;: 10025, &#39;decisions&#39;: [(&#39;F-Prot Plugin&#39;, 0), (&#39;ClamavPlugin&#39;, 0)], &#39;ClamavPlugin.time&#39;: &#39;0.0092&#39;} : Running Plugin SAPlugin
*******
[102]: waiting for task
*******
[103]: waiting for task
*******
[104]: waiting for task
*******
[105]: waiting for task
*******
[106]: Suspect b47e2ebf00e3f0d83dc1c7f64dad69e8: from=&lt;redacted&gt; to=&lt;redacted&gt; size=29442 , spam=no, virus=no tags={&#39;virus&#39;: {&#39;F-Prot&#39;: False, &#39;ClamAV&#39;: False}, &#39;FprotPlugin.time&#39;: &#39;0.0240&#39;, &#39;spam&#39;: {}, &#39;incomingport&#39;: 10025, &#39;decisions&#39;: [(&#39;F-Prot Plugin&#39;, 0), (&#39;ClamavPlugin&#39;, 0)], &#39;ClamavPlugin.time&#39;: &#39;0.0240&#39;} : Running Plugin SAPlugin
*******
[107]: waiting for task
</pre></div>
</div>
<p>run fuglu_control without arguments to get a list of all supported commands.</p>
</div>
<div class="section" id="logs">
<h3>Logs<a class="headerlink" href="#logs" title="Permalink to this headline">¶</a></h3>
<p>Fuglu writes to /var/log/fuglu/fuglu.log by default. A summary of each analyzed message is stored in that file immediately after it has been analyzed..</p>
<p>Fuglu uses the standard python logging framework. This allows you to configure logging for each plugin individually (verbosity, own logfile, ...)</p>
<p>Full documentation on the python logging configuration: <a class="reference external" href="http://docs.python.org/library/logging.html#configuring-logging">http://docs.python.org/library/logging.html#configuring-logging</a></p>
<p>Logging is configured in <tt class="docutils literal"><span class="pre">/etc/fuglu/logging.conf</span></tt></p>
<p>in standard configuration, fuglu logs only INFO messages. Let&#8217;s say you wanted to debug the spamassassin plugin. So you&#8217;d check if there is a section dealing with spamassassin and you&#8217;d find this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">logger_saplugin</span><span class="p">]</span>
<span class="n">level</span><span class="o">=</span><span class="n">INFO</span>
<span class="n">handlers</span><span class="o">=</span><span class="n">logfile</span>
<span class="n">propagate</span><span class="o">=</span><span class="mi">0</span>
<span class="n">qualname</span><span class="o">=</span><span class="n">fuglu</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">SAPlugin</span>
</pre></div>
</div>
<p>You would change <tt class="docutils literal"><span class="pre">level=INFO</span></tt> to <tt class="docutils literal"><span class="pre">level=DEBUG</span></tt>. Also you need to activate this special configuration for spamassassin by adding it to the loggers section at the top of the file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">loggers</span><span class="p">]</span>
<span class="n">keys</span><span class="o">=</span><span class="n">root</span><span class="p">,</span><span class="n">saplugin</span>
</pre></div>
</div>
<p>after reloading fuglu, the spamassassin plugin should be very verbose:</p>
<div class="highlight-python"><div class="highlight"><pre>2009-04-08 17:11:07,693 fuglu.plugin.SAPlugin: DEBUG Contacting spamd localhost (Try 1 of 5)
2009-04-08 17:11:07,701 fuglu.plugin.SAPlugin: DEBUG Sent 4065 bytes to spamd
2009-04-08 17:11:10,033 fuglu.plugin.SAPlugin: DEBUG SPAMD/1.1 0 EX_OK

2009-04-08 17:11:10,034 fuglu.plugin.SAPlugin: DEBUG Got 4778 message bytes from back from spamd
2009-04-08 17:11:10,047 fuglu.plugin.SAPlugin: DEBUG Spamscore: 2.2
2009-04-08 17:11:10,047 fuglu.plugin.SAPlugin: DEBUG Message is not spam
</pre></div>
</div>
<p>there should be logger sections configured for most tasks / plugins, if not, do not hesitate to open a bug on this.</p>
<p><strong>Qualnames for new loggers</strong> :</p>
<p>Plugins usually use <tt class="docutils literal"><span class="pre">fuglu.plugin.&lt;classname&gt;</span></tt></p>
<p>fuglu internal qualnames:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">fuglu.SessionHandler</span></tt> - What plugins are being run, what are the results, ...</li>
<li><tt class="docutils literal"><span class="pre">fuglu.smtp.incoming</span></tt> - Incoming smtp connections</li>
<li><tt class="docutils literal"><span class="pre">fuglu.smtp.incoming.&lt;portnumber&gt;</span></tt> - Incoming smtp sessions on port &lt;portnumber&gt;</li>
<li><tt class="docutils literal"><span class="pre">fuglu.smtpsession</span></tt> - information on the incoming smtp transaction</li>
<li><tt class="docutils literal"><span class="pre">fuglu.threadpool</span></tt> - information when threads are created / destroyed</li>
<li><tt class="docutils literal"><span class="pre">fuglu.headerfilter</span></tt> - debug info on parsing/applying the special header filter config files</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="mrtg">
<h3>MRTG<a class="headerlink" href="#mrtg" title="Permalink to this headline">¶</a></h3>
<p>Fuglu can be configured to peridically write status files readable by mrtg. To do this, you only have to create a new directory (eg <tt class="docutils literal"><span class="pre">/usr/local/fuglu/mrtg</span></tt>) and set this in <tt class="docutils literal"><span class="pre">fuglu.conf</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>#Statistics
mrtgdir=/usr/local/fuglu/mrtg
</pre></div>
</div>
<p>You&#8217;ll need <em>mrtg</em> and a <em>webserver</em> for this to work... create a file called <tt class="docutils literal"><span class="pre">/etc/fuglu/fuglu_mrtg.cfg</span></tt>  like this:</p>
<div class="highlight-python"><div class="highlight"><pre>Interval: 5
WorkDir: /usr/local/fuglu/mrtg/output
WriteExpires: yes
Options[_]: growright,nopercent
LogFormat: rrdtool

#---------------------------------------------------------------
Target[inout]: `cat /usr/local/fuglu/mrtg/inout`
PageTop[inout]: &lt;H1&gt;Messages in/out&lt;/H1&gt;
Options[inout]: growright,nopercent
Title[inout]: Messages in/out
ShortLegend[inout]: msgs/s
YLegend[inout]: messages
LegendI[inout]: in
Legend1[inout]: Incoming Messages
Legend2[inout]: Messages re-injected
LegendO[inout]: re-inject
MaxBytes[inout]: 60000000

Target[hamspam]: `cat /usr/local/fuglu/mrtg/hamspam`
Options[hamspam]: growright,nopercent
Title[hamspam]: Ham / Spam
PageTop[hamspam]: &lt;H1&gt;Ham / Spam&lt;/H1&gt;
YLegend[hamspam]: messages/second
ShortLegend[hamspam]: msgs/s
LegendI[hamspam]: ham
Legend1[hamspam]: Clean Messages (ham)
LegendO[hamspam]: spam
Legend2[hamspam]: Messages detected as spam
MaxBytes[hamspam]: 600000
AbsMax[hamspam]: 600000

Target[scantime]: `cat /usr/local/fuglu/mrtg/scantime`
Options[scantime]: growright,nopercent,gauge
Title[scantime]: Scan Time
PageTop[scantime]: &lt;H1&gt;Scan Time&lt;/H1&gt;
WithPeak[scantime]: ymwd
YLegend[scantime]: sec
ShortLegend[scantime]: sec
Legend1[scantime]: Time needed to analyze message
LegendI[scantime]: scantime
LegendO[scantime]:
Legend2[scantime]:
Legend3[scantime]: Peak Scantime
Legend4[scantime]:
MaxBytes[scantime]: 600000
AbsMax[scantime]: 600000


Target[threads]: `cat /usr/local/fuglu/mrtg/threads`
Options[threads]: growright,nopercent,gauge
Title[threads]: Threads
PageTop[threads]: &lt;H1&gt;Running Threads&lt;/H1&gt;
YLegend[threads]: threads
ShortLegend[threads]: threads
LegendO[threads]:
Legend1[threads]: Number of running threads
Legend2[threads]:
LegendI[threads]: threads
MaxBytes[threads]: 600000
AbsMax[threads]: 600000


Target[virus]: `cat /usr/local/fuglu/mrtg/virus`
Options[virus]: growright,nopercent
Title[virus]: virus
PageTop[virus]: &lt;H1&gt;Virus&lt;/H1&gt;
YLegend[virus]: virus
ShortLegend[virus]: virus
#LegendO[virus]: virus
LegendI[virus]: virus
Legend1[virus]: Number of viri detected
MaxBytes[virus]: 600000
AbsMax[virus]: 600000
</pre></div>
</div>
<p>make sure, the path in WorkDir exists.</p>
<p>then create a script <tt class="docutils literal"><span class="pre">/usr/local/bin/fuglu_mrtg.sh</span></tt></p>
<div class="highlight-python"><div class="highlight"><pre>#!/bin/sh
/usr/bin/env LANG=C /usr/bin/mrtg /etc/fuglu/fuglu_mrtg.cfg
</pre></div>
</div>
<p>run <tt class="docutils literal"><span class="pre">fuglu_mrtg.sh</span></tt> to check for errors.</p>
<p>if all went well, add it to your crontab:</p>
<div class="highlight-python"><div class="highlight"><pre>*/5 * * * * /usr/local/bin/fuglu_mrtg.sh &gt;/dev/null 2&gt;&amp;1
</pre></div>
</div>
<p>install mrtg-rrd.cgi (probably rename it to fuglu.cgi ), and configure the path to fuglu_mrtg.cfg correctly:</p>
<div class="highlight-python"><div class="highlight"><pre># EDIT THIS to reflect all your MRTG config files
BEGIN { @config_files = qw(/etc/fuglu/fuglu_mrtg.cfg); }
</pre></div>
</div>
<p>after pointing your browser to <tt class="docutils literal"><span class="pre">http://yourfuglubox.example.com/cgi-bin/fuglu.cgi</span></tt> you should see nice graphs.</p>
</div>
</div>
<div class="section" id="troubleshooting-debugging">
<h2>Troubleshooting &amp; Debugging<a class="headerlink" href="#troubleshooting-debugging" title="Permalink to this headline">¶</a></h2>
<div class="section" id="fuglu-doesn-t-even-start">
<h3>Fuglu doesn&#8217;t even start<a class="headerlink" href="#fuglu-doesn-t-even-start" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>run <tt class="docutils literal"><span class="pre">fuglu</span> <span class="pre">--lint</span></tt> as root. are there any errors?</li>
<li>did you create /etc/fuglu/logging.conf (by renaming the logging.conf.dist file) ?</li>
<li>check if the log directory (/var/log/fuglu/ by default) exists an is writable by the user running fuglu</li>
<li>check for errors in /var/log/fuglu.log</li>
<li>run fuglu fuglu in foreground using <tt class="docutils literal"><span class="pre">fuglu</span> <span class="pre">--foreground</span></tt> or by setting <tt class="docutils literal"><span class="pre">daemonize=0</span></tt> in fuglu.conf and check for errors</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="debug-trace-a-single-message">
<h3>Debug Trace a single message<a class="headerlink" href="#debug-trace-a-single-message" title="Permalink to this headline">¶</a></h3>
<p>Fuglu runs but you want to know what exactly would happen to a single email message?</p>
<p>Make sure message debugging is enabled (it is by default, but if you screwed up your config...) :</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">prependers=</span></tt> should start with <tt class="docutils literal"><span class="pre">debug</span></tt> to make sure the debugger plugin is loaded</li>
<li><tt class="docutils literal"><span class="pre">incomingport</span></tt> option should contian port 10888 (eg. incomingport=10025,10099,10888 ) , so fuglu listens on the debugging port</li>
<li>in the [debug] section, set debugport=10888 and debugfile=/tmp/fuglu_debug.log , so the debugger plugin knows what port to treat as debug port and where to store debug information</li>
<li><tt class="docutils literal"><span class="pre">nobounce</span></tt> should be set to True, so debugged messages can not be bounced</li>
<li><tt class="docutils literal"><span class="pre">noreinject</span></tt> shoud be set to True, so debugged messages are not re-injected to postfix for further processing</li>
<li><tt class="docutils literal"><span class="pre">noappender</span></tt> should be set to True, so appenders are not run for debugged messages</li>
</ul>
</div></blockquote>
<p>Save the message on the server (rfc822 format), and run</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">fuglu_debug</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">message</span><span class="o">.</span><span class="n">eml</span>
</pre></div>
</div>
<p>you may add envelope sender and recipient if these are relevant for your test, eg:</p>
<div class="highlight-python"><div class="highlight"><pre>fuglu_debug /path/to/message.eml sender@example.org recipient@example.net
</pre></div>
</div>
<p>then check <tt class="docutils literal"><span class="pre">/tmp/fuglu_debug.log</span></tt></p>
</div>
<div class="section" id="debug-a-suspect-filter">
<span id="debug-suspect-filter"></span><h3>Debug a suspect filter<a class="headerlink" href="#debug-a-suspect-filter" title="Permalink to this headline">¶</a></h3>
<p>So you have this filter in a plugin with hundreds of rules and you just don&#8217;t know which one matched a specific message?</p>
<p>fuglu_suspectfilter to the rescue! just pass a rule file and a message eml file as arguments and it will list all matches.</p>
<div class="highlight-python"><div class="highlight"><pre>fuglu_suspectfilter /etc/fuglu/myfilterfile.regex /tmp/testmessage.eml
INFO:fuglu.suspectfilter:Reloading Rulefile /home/gryphius/Documents/skipreviewfilter.regex
INFO:root:194 valid rules found
INFO:root:1 matches found

Match #1:
Matched header/field: From
Matched value in message: &quot;Edgar&quot; &lt;edgarmail@example.com&gt;
Regex : edgarmail@example\.com
Rule argument : Messages from Edgar
</pre></div>
</div>
<p>add a <cite>-D</cite> argument for a full debug trace of the suspect filter.</p>
</div>
<div class="section" id="debug-the-fuglu-core">
<h3>Debug the fuglu core<a class="headerlink" href="#debug-the-fuglu-core" title="Permalink to this headline">¶</a></h3>
<p>If you are a python developer and would like to inspect fuglu at run-time, add the argument <tt class="docutils literal"><span class="pre">--console</span></tt> when starting fuglu.
You will then get an interactive python console where all plugins etc are available from the &#8216;mc&#8217; (MainController) object</p>
<p>starting with fuglu 0.6.1 it is also possible to start a network-enabled python shell using the command <tt class="docutils literal"><span class="pre">fuglu_control</span> <span class="pre">netconsole</span> <span class="pre">[&lt;port&gt;</span> <span class="pre">[&lt;bindaddress&gt;]]</span></tt></p>
<p>Example:
on the host running fuglu:</p>
<div class="highlight-python"><div class="highlight"><pre># fuglu_control netconsole 9999 0.0.0.0
Python interactive console starting on 0.0.0.0 port 9999
</pre></div>
</div>
<p>on your host:</p>
<div class="highlight-python"><div class="highlight"><pre>$ nc 192.168.1.40 9999
Fuglu Python Shell - MainController available as &#39;mc&#39;
&gt;&gt;&gt;
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <div class="sphinxlocaltoc">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Operation</a><ul>
<li><a class="reference internal" href="#monitoring">Monitoring</a><ul>
<li><a class="reference internal" href="#command-line-interface">Command Line Interface</a></li>
<li><a class="reference internal" href="#logs">Logs</a></li>
<li><a class="reference internal" href="#mrtg">MRTG</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting-debugging">Troubleshooting &amp; Debugging</a><ul>
<li><a class="reference internal" href="#fuglu-doesn-t-even-start">Fuglu doesn&#8217;t even start</a></li>
<li><a class="reference internal" href="#debug-trace-a-single-message">Debug Trace a single message</a></li>
<li><a class="reference internal" href="#debug-a-suspect-filter">Debug a suspect filter</a></li>
<li><a class="reference internal" href="#debug-the-fuglu-core">Debug the fuglu core</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <h4>Previous topic</h4>
  <p class="topless"><a href="configuration-index.html"
                        title="previous chapter">Configuration</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="plugins-index.html"
                        title="next chapter">Plugins</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/operation-index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="plugins-index.html" title="Plugins"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="configuration-index.html" title="Configuration"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="index.html">fuglu 1 documentation</a> &raquo;</li>
 
      </ul>
    </div>
    </div>

    <div class="footer">
        &copy; Copyright 2012, gryphius.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>